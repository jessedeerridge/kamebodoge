<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ã‹ã‚ã®ãƒœãƒ‰ã‚²</title>

  <!-- âœ… Firebase (v9 compat) : Auth + Realtime Database -->
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --line:rgba(0,0,0,.08);
      --text:#111827;
      --muted:rgba(17,24,39,.65);
      --accent:#2563eb;
      --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(37,99,235,.08), transparent 60%),
        radial-gradient(900px 600px at 80% 10%, rgba(99,102,241,.06), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(255,255,255,.92), rgba(255,255,255,.72));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:5px 16px;}
    .bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.02em;
      font-size:18px;
      min-width:0;
    }
    .turtle{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(99,102,241,.14));
      border:1px solid rgba(0,0,0,.10);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      user-select:none;
      flex:0 0 auto;
    }
    .turtle span{font-size:18px; transform: translateY(-1px);}

    .authArea{
      display:flex; align-items:center; gap:10px;
      flex:0 0 auto;
    }
    .userPill{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.80);
      border-radius: 999px;
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
      max-width: 58vw;
    }
    .userEmail{
      font-size:12px;
      color: rgba(17,24,39,.78);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 34vw;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.90);
      color: var(--text);
      padding:9px 12px;
      border-radius: 12px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ background: #fff; border-color: rgba(0,0,0,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(99,102,241,.12));
      border-color: rgba(37,99,235,.25);
    }
    .btn.ghost{
      background: transparent;
      box-shadow: none;
    }
    .btn.small{ padding:7px 10px; border-radius: 10px; font-size:12px; }
    .btn.danger{
      background: rgba(185, 28, 28, .07);
      border-color: rgba(185, 28, 28, .18);
      color: #7f1d1d;
    }

    .grid{
      max-width:1100px;
      margin:0 auto;
      padding:16px 3px 10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      align-items:stretch;
    }
    @media (min-width: 700px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .slot{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,250,252,.98));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width:0;
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .secondframe{
      position:absolute;
      inset:0;
      z-index:4;
      pointer-events:auto;
      display:grid;
      place-items:center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: pan-y;
    }
    .secondframe::before{
      content:"";
      width:100%;
      height:100%;
      transform: scale(.88);
      border-radius: calc(var(--radius) * .9);
      border: 0;
      background: transparent;
      box-shadow: none;
      pointer-events:none;
      opacity: 0;
    }

    .sfOverlay{
      position:absolute;
      inset:0;
      z-index:7;
      display:none;
      pointer-events:auto;
      -webkit-tap-highlight-color: transparent;
      background: transparent;
    }
    .sfOverlay.show{ display:block; }

    .sfInner{
      position:absolute;
      left:50%;
      top:50%;
      width:100%;
      height:100%;
      transform: translate(-50%,-50%) scale(.88);
      border-radius: calc(var(--radius) * .9);
      overflow:hidden;
      background: rgba(0,0,0,.06);
      backdrop-filter: blur(2px);
    }

    .sfOverlay .sfImgLink{
      position:absolute;
      inset:0;
      display:block;
      text-decoration:none;
      touch-action: manipulation;
      cursor: pointer;
    }
    .sfOverlay img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    .sfOverlay .sfClose{
      position:absolute;
      right:10px;
      top:10px;
      z-index:2;
      width:38px;
      height:38px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.25);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .sfOverlay .sfClose:active{ transform: translateY(1px); }

    .infoBox{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      min-width:0;
      flex:1 1 auto;
      position:relative;
      z-index:3;
      pointer-events:none;
    }

    .topRow{
      display:grid;
      grid-template-columns: 2fr 3fr;
      gap:10px;
      align-items:start;
      min-width:0;
    }

    .imgCol{ min-width:0; }
    .imgBase{
      width:100%;
      border-radius:14px;
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:72px;
    }
    .imgBase .previewImg{
      width:100%;
      height:auto;
      max-width:100%;
      display:block;
      pointer-events:none;
      user-select:none;
      background: transparent;
    }
    .imgBase .empty{
      color: rgba(17,24,39,.40);
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      user-select:none;
      padding:14px 0;
    }

    .metaCol{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .gameTitle{
      color:var(--text);
      font-weight:900;
      font-size:15px;
      line-height:1.25;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      overflow-wrap:anywhere;
      word-break: break-word;
      display:block;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      margin-top:-2px;
      min-width:0;
    }
    .metaPill{
      font-size:12px;
      font-weight:900;
      color: rgba(17,24,39,.78);
      user-select:none;
      padding:4px 2px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
      line-height:1;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .tagRow{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      align-items:center;
      margin-top:-2px;
    }
    .tagChip{
      font-size:11px;
      font-weight:900;
      padding:3px 7px;
      border-radius: 999px;
      border:1px solid rgba(37,99,235,.18);
      background: rgba(37,99,235,.10);
      color: rgba(17,24,39,.90);
      line-height:1.1;
      white-space:nowrap;
    }

    .descBox{
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.01);
      border: 1px solid rgba(0,0,0,.06);
      min-width:0;
    }
    .desc{
      margin:0;
      color: var(--muted);
      line-height:1.45;
      font-size:13px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap:anywhere;
    }

    .cardEditBtn{
      position:absolute;
      right:10px;
      bottom:10px;
      z-index:6;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      color: rgba(17,24,39,.92);
      font-weight:900;
      font-size:12px;
      padding:7px 10px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .cardEditBtn:hover{
      border-color: rgba(37,99,235,.28);
      background: rgba(37,99,235,.10);
    }
    .cardEditBtn:active{ transform: translateY(1px); }

    .grid.reorder .slot[data-my="1"]{ cursor: grab; }
    .grid.reorder .slot[data-my="1"]:active{ cursor: grabbing; }
    .grid.reorder .slot[data-my="1"]{
      outline: 2px dashed rgba(37,99,235,.25);
      outline-offset: 6px;
      border-radius: 18px;
    }
    .grid.reorder .slot.dragging{
      opacity:.55;
      outline-color: rgba(37,99,235,.55);
    }

    .dropHint{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      z-index: 998;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.88);
      box-shadow: 0 18px 50px rgba(0,0,0,.14);
      font-size:12px;
      font-weight:900;
      color: rgba(17,24,39,.85);
      display:none;
      user-select:none;
      white-space:nowrap;
    }
    .dropHint.show{ display:block; }

    .footnote{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 22px;
      color: rgba(17,24,39,.55);
      font-size:12px;
      line-height:1.6;
    }
    .footnote code{
      background: rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.08);
      padding:2px 6px;
      border-radius:8px;
    }

    .admin{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 18px;
    }
    .adminCard{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.80);
      border-radius: 18px;
      box-shadow: 0 14px 34px rgba(0,0,0,.10);
      overflow:hidden;
    }
    .adminHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .adminTitle{
      font-weight:900;
      letter-spacing:.02em;
      font-size:14px;
    }
    .adminBody{
      padding:12px 14px 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .adminBody{
        grid-template-columns: 1.1fr 1.1fr 1.1fr 1.2fr;
      }
      .adminBody .wide{ grid-column: 1 / -1; }
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width:0;
    }
    .label{
      font-size:12px;
      color: rgba(17,24,39,.70);
      font-weight:800;
      letter-spacing:.02em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label .miniRight{
      font-size:11px;
      font-weight:900;
      opacity:.7;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .input, .textarea{
      width:100%;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
    }
    .input:focus, .textarea:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }
    .textarea{
      min-height: 78px;
      resize: vertical;
      line-height:1.45;
    }
    .hint{
      font-size:11px;
      color: rgba(17,24,39,.55);
      line-height:1.45;
    }
    .rowActions{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      padding-top: 6px;
      flex-wrap: wrap;
    }
    .status{
      font-size:12px;
      color: rgba(17,24,39,.65);
      min-height: 16px;
    }
    .status.err{ color: #b91c1c; }
    .status.ok{ color: #047857; }

    .stepper{
      display:flex; align-items:center; gap:8px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      border-radius: 12px;
      padding:8px 8px;
      min-height: 40px;
    }
    .stepVal{
      flex:1 1 auto;
      font-weight:900;
      color: rgba(17,24,39,.92);
      font-size:13px;
      letter-spacing:.02em;
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stepBtns{
      display:flex; gap:6px; flex:0 0 auto;
    }
    .stepBtn{
      width:34px; height:30px;
      border-radius: 10px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      color: rgba(17,24,39,.92);
      cursor:pointer;
      font-weight:900;
      line-height:1;
      user-select:none;
      touch-action: manipulation;
    }
    .stepBtn:hover{ background: rgba(0,0,0,.05); border-color: rgba(0,0,0,.18); }
    .stepBtn:active{ transform: translateY(1px); }

    .tagInputRow{
      display:flex; gap:8px; align-items:center;
      flex-wrap:wrap;
    }
    .tagInputRow .input{ flex:1 1 260px; }
    .tagPills{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      align-items:center;
      padding:6px 0 0;
      min-height: 22px;
    }
    .tagPickChip{
      font-size:11px;
      font-weight:900;
      padding:3px 7px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
      color: rgba(17,24,39,.90);
      cursor:pointer;
      user-select:none;
      line-height:1.1;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .tagPickChip:hover{ background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.22); }
    .tagPickChip.on{
      background: rgba(37,99,235,.14);
      border-color: rgba(37,99,235,.28);
    }
    .tagPickChip.dragging{
      opacity:.55;
      outline: 2px dashed rgba(37,99,235,.35);
      outline-offset: 3px;
    }
    .tagPickChip .x{ opacity:.85; font-weight:900; }
    .tagPickChip .del{
      opacity:.9;
      font-weight:900;
      color:#b91c1c;
    }

    .modalOverlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,250,252,.98));
      box-shadow: 0 26px 70px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .tabs{ display:flex; gap:8px; align-items:center; }
    .tab{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      color: rgba(17,24,39,.78);
      padding:8px 10px;
      border-radius: 999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      touch-action: manipulation;
    }
    .tab.active{
      background: rgba(37,99,235,.14);
      border-color: rgba(37,99,235,.28);
      color: var(--text);
    }
    .closeX{
      border:0;
      background: transparent;
      color: rgba(17,24,39,.72);
      font-size:18px;
      cursor:pointer;
      padding: 6px 10px;
      border-radius: 10px;
      touch-action: manipulation;
    }
    .closeX:hover{ background: rgba(0,0,0,.04); }

    .modalBody{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modalErr{
      font-size:12px;
      color:#b91c1c;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .modalErr.show{ display:block; }

    .hr{
      height:1px; background: rgba(0,0,0,.08);
      margin: 4px 0;
    }
    .mutedNote{
      font-size:12px;
      color: rgba(17,24,39,.62);
      line-height:1.55;
    }

    .hidden{ display:none !important; }

    /* =========================
       âœ… Special FIRST tile (NOW PLAY)
       ========================= */
    .slot.special{
      background: transparent;
      border-color: rgba(0,0,0,.12);
      padding:12px;
      display:flex;
      box-shadow: var(--shadow);
    }
    .slot.special .nowPlayArea{
      width:100%;
      border-radius:14px;
      overflow:hidden;
      position:relative;
      border:1px solid rgba(0,0,0,.10);
      background: transparent;
      min-height:140px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .slot.special .nowPlayArea img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    .nowPlayText{
      position:absolute;
      inset:0;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      letter-spacing: .10em;
      color:#000;
      font-size: clamp(28px, 4.2vw, 62px);
      line-height:1;
      pointer-events:none;
      user-select:none;
      text-shadow: 0 2px 10px rgba(255,255,255,.55);
    }

    .nowPlayClickLayer{
      position:absolute;
      inset:0;
      z-index:5;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      pointer-events:auto;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="bar">
        <div class="brand">
          <div class="turtle" aria-hidden="true"><span>ğŸ¢</span></div>
          <div>ã‹ã‚ã®ãƒœãƒ‰ã‚²</div>
        </div>

        <div class="authArea" aria-label="auth-area">
          <button class="btn primary" id="btnLogin">ãƒ­ã‚°ã‚¤ãƒ³</button>

          <div class="userPill hidden" id="userPill">
            <div class="userEmail" id="userEmail">-</div>
            <button class="btn ghost small" id="btnLogout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="admin hidden" id="adminPanel">
      <div class="adminCard">
        <div class="adminHead">
          <div class="adminTitle" id="adminTitleText">ã‚²ãƒ¼ãƒ è¿½åŠ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ï¼‰</div>
          <div class="status" id="adminStatus"></div>
        </div>

        <div class="adminBody">
          <div class="field">
            <div class="label">åå‰</div>
            <input class="input" id="fName" placeholder="ä¾‹ï¼šæ–°ã—ã„ãƒœãƒ‰ã‚²" />
          </div>

          <div class="field">
            <div class="label">ãƒªãƒ³ã‚¯</div>
            <input class="input" id="fUrl" placeholder="https://example.com/" />
            <div class="hint">â€» http(s) ã®URLæ¨å¥¨</div>
          </div>

          <div class="field">
            <div class="label">ç”»åƒãƒªãƒ³ã‚¯ï¼ˆä»»æ„ï¼‰</div>
            <input class="input" id="fImgUrl" placeholder="https://.../image.png" />
            <div class="hint">é€éPNGãªã©ã®URLæ¨å¥¨ï¼ˆç·¨é›†æ™‚ï¼šç©ºãªã‚‰ã€Œç”»åƒã¯å¤‰æ›´ã—ãªã„ã€ï¼‰</div>
          </div>

          <div class="field">
            <div class="label">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä»»æ„ / DBä¿å­˜ï¼‰</div>
            <input class="input" id="fImgFile" type="file" accept="image/*" />
            <div class="hint">â€» Storageä¸ä½¿ç”¨ã€‚é¸ã¶ã¨ dataURL ã§DBã«ä¿å­˜ï¼ˆå¤§ãã„ç”»åƒã¯éæ¨å¥¨ï¼‰</div>
          </div>

          <div class="field">
            <div class="label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ç”»åƒãƒªãƒ³ã‚¯ï¼ˆä»»æ„ï¼‰</div>
            <input class="input" id="fPrevImgUrl" placeholder="https://.../preview.jpg" />
            <div class="hint">secondframeã§æ å†…è¡¨ç¤ºã§ãã¾ã™ã€‚</div>
          </div>

          <div class="field">
            <div class="label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä»»æ„ / DBä¿å­˜ï¼‰</div>
            <input class="input" id="fPrevImgFile" type="file" accept="image/*" />
            <div class="hint">â€» Storageä¸ä½¿ç”¨ã€‚é¸ã¶ã¨ dataURL ã§DBã«ä¿å­˜ï¼ˆå¤§ãã„ç”»åƒã¯éæ¨å¥¨ï¼‰</div>
          </div>

          <div class="field">
            <div class="label">äººæ•°ï¼ˆğŸ‘¤ min~maxï¼‰</div>
            <div class="stepper" aria-label="players-stepper">
              <div class="stepVal" id="fPlayersLabel">ğŸ‘¤3~6</div>
              <div class="stepBtns">
                <button class="stepBtn" id="plMinDown" title="min â–¼">â–¼</button>
                <button class="stepBtn" id="plMinUp"   title="min â–²">â–²</button>
              </div>
              <div style="width:1px;height:20px;background:rgba(0,0,0,.12);"></div>
              <div class="stepBtns">
                <button class="stepBtn" id="plMaxDown" title="max â–¼">â–¼</button>
                <button class="stepBtn" id="plMaxUp"   title="max â–²">â–²</button>
              </div>
            </div>
            <div class="hint">å·¦ãŒ minã€å³ãŒ maxã€‚min â‰¤ max ã§è‡ªå‹•èª¿æ•´ã€‚</div>
          </div>

          <div class="field">
            <div class="label">æ™‚é–“ï¼ˆâŒš åˆ†ï¼‰</div>
            <div class="stepper" aria-label="time-stepper">
              <div class="stepVal" id="fTimeLabel">âŒš20m</div>
              <div class="stepBtns">
                <button class="stepBtn" id="tmDown" title="â–¼">â–¼</button>
                <button class="stepBtn" id="tmUp"   title="â–²">â–²</button>
              </div>
            </div>
            <div class="hint">5åˆ†åˆ»ã¿ï¼ˆæœ€å°5 / æœ€å¤§240ï¼‰</div>
          </div>

          <div class="field wide">
            <div class="label">
              <span>ã‚¿ã‚°ï¼ˆæ–°è¦è¿½åŠ OK / ç™»éŒ²å¾Œã‚‚æµç”¨ï¼‰</span>
              <span class="miniRight">
                <span class="hint" style="margin:0;">â€»é¸æŠä¸­ã‚¿ã‚°ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆå¯</span>
              </span>
            </div>

            <div class="tagInputRow">
              <input class="input" id="fTagInput" placeholder="ã‚¿ã‚°è¿½åŠ ï¼ˆä¾‹ï¼šå”åŠ› / æ­£ä½“éš åŒ¿ / æ¨ç†ï¼‰" />
              <button class="btn small" id="btnTagAdd">è¿½åŠ </button>
            </div>

            <div class="hint">
              ãƒ»ã€Œè¿½åŠ ã€ã‚’æŠ¼ã™ã¨ <b>tags(ã‚¿ã‚°è¾æ›¸)</b> ã«ä¿å­˜ã•ã‚Œã€ä»¥é™ã‚‚å€™è£œã«å‡ºã¾ã™ã€‚<br/>
              ãƒ»ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜ã—ãŸæ™‚ã‚‚ã€é¸æŠã‚¿ã‚°ã¯è‡ªå‹•ã§è¾æ›¸ã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚<br/>
              ãƒ»æ—¢å­˜ã‚¿ã‚°ã®å³å´ã® <b>ğŸ—‘</b> ã‚’æŠ¼ã™ã¨ã€è¾æ›¸ã‹ã‚‰å‰Šé™¤ã§ãã¾ã™ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆï¼‰ã€‚
            </div>

            <div class="hint" style="margin-top:6px;">é¸æŠä¸­ã‚¿ã‚°ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§é †ç•ªå¤‰æ›´ / ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼‰</div>
            <div class="tagPills" id="selectedTags"></div>

            <div class="hint" style="margin-top:6px;">æ—¢å­˜ã‚¿ã‚°ï¼ˆDBä¿å­˜ï¼‰</div>
            <div class="tagPills" id="tagSuggestions"></div>
          </div>

          <div class="field wide">
            <div class="label">èª¬æ˜</div>
            <textarea class="textarea" id="fDesc" placeholder="ã‚²ãƒ¼ãƒ ã®èª¬æ˜..."></textarea>
          </div>

          <div class="field">
            <div class="label">æ“ä½œ</div>
            <div class="rowActions">
              <button class="btn" id="btnClear">ã‚¯ãƒªã‚¢</button>
              <button class="btn" id="btnCancelEdit" style="display:none;">ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button class="btn primary" id="btnAdd">è¿½åŠ </button>
            </div>
            <div class="hint" id="adminHint">è¿½åŠ ã™ã‚‹ã¨Realtime DBã¸æ›¸ãè¾¼ã¿â†’ä¸€è¦§ã«å³åæ˜ </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid reorder" id="grid"></section>

    <div class="dropHint" id="dropHint">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆä¸­â€¦</div>

    <div class="footnote"></div>
  </main>

  <!-- ===== Modal: Auth ===== -->
  <div class="modalOverlay" id="authModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="auth-modal">
      <div class="modalHead">
        <div class="tabs">
          <div class="tab active" id="tabLogin">ãƒ­ã‚°ã‚¤ãƒ³</div>
          <div class="tab" id="tabSignup">æ–°è¦ç™»éŒ²</div>
        </div>
        <button class="closeX" id="btnCloseModal" aria-label="close">Ã—</button>
      </div>

      <div class="modalBody">
        <div class="mutedNote">
          Firebaseãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ–¹å¼ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€ä¸Šã®ã€Œã‚²ãƒ¼ãƒ è¿½åŠ ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>

        <div class="field">
          <div class="label">
            <span>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</span>
            <span class="miniRight"><span class="hint" style="margin:0;">å…¥åŠ›ã¯ä¿å­˜ã•ã‚Œã¾ã™</span></span>
          </div>
          <input class="input" id="authEmail" type="email" autocomplete="email" placeholder="name@example.com" />
        </div>

        <div class="field">
          <div class="label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
          <input class="input" id="authPass" type="password" autocomplete="current-password" placeholder="6æ–‡å­—ä»¥ä¸Š" />
        </div>

        <div class="modalErr" id="authErr"></div>

        <div class="rowActions" style="justify-content:flex-end;">
          <button class="btn" id="btnAuthDo">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <div class="hr"></div>
        <div class="mutedNote" id="authModeNote">
          æ–°è¦ç™»éŒ²ãŒå¿…è¦ãªã‚‰ã€Œæ–°è¦ç™»éŒ²ã€ã‚¿ãƒ–ã¸ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Modal: NOW PLAY password (long-press) ===== -->
  <div class="modalOverlay" id="pwModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="password-modal">
      <div class="modalHead">
        <div class="adminTitle" style="font-size:14px;">NOW PLAY è¨­å®š</div>
        <button class="closeX" id="btnPwClose" aria-label="close">Ã—</button>
      </div>
      <div class="modalBody">
        <div class="mutedNote" id="pwTargetNote">é•·æŠ¼ã—ã—ãŸã‚²ãƒ¼ãƒ ã‚’å…ˆé ­æ ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</div>

        <div class="field">
          <div class="label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
          <input class="input" id="pwInput" type="password" inputmode="numeric" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
        </div>

        <div class="modalErr" id="pwErr"></div>

        <div class="rowActions" style="justify-content:flex-end;">
          <button class="btn" id="btnPwCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primary" id="btnPwOk">OK</button>
        </div>

        <div class="hint" style="margin-top:4px;">
          â€» ã‚¹ãƒãƒ›ã§ã€Œæ›´æ–°ã•ã‚Œãªã„ã€å•é¡Œå¯¾ç­–ï¼šNOW PLAY ã‚’ <b>DBã«ä¿å­˜ã—ã¦å…¨ç«¯æœ«ã¸åŒæœŸ</b>ã—ã¾ã™ã€‚<br/>
          ï¼ˆãã®ãŸã‚ NOW PLAY è¨­å®šã¯ <b>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿</b>å¯èƒ½ã«ã—ã¦ã„ã¾ã™ï¼‰
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // âœ… Firebase Config
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDUP1foVQnitM45do_UtYLkcc9gvgQC-xw",
      authDomain: "timebomb-3b0c7.firebaseapp.com",
      databaseURL: "https://timebomb-3b0c7-default-rtdb.firebaseio.com",
      projectId: "timebomb-3b0c7",
      storageBucket: "timebomb-3b0c7.firebasestorage.app",
      messagingSenderId: "532935786630",
      appId: "1:532935786630:web:ef1f97c862bfaad67d1107",
      measurementId: "G-K8NRR8K64Y"
    };

    // =========================
    // âœ… åˆæœŸã‚²ãƒ¼ãƒ ï¼ˆæ—§åˆ†ã¯æ¶ˆã•ãªã„ï¼‰
    // =========================
    const seedGames = [];
    const TOTAL_SLOTS = 50;

    // =========================
    // âœ… localStorage keys
    // =========================
    const LS_AUTH_EMAIL = "kame_bodoge_auth_email";
    const LS_NOW_PLAY   = "kame_bodoge_now_play_v1"; // {gid,url,previewImg,hhmm,setAt,name}

    // =========================
    // âœ… DOM
    // =========================
    const grid = document.getElementById("grid");
    const dropHint = document.getElementById("dropHint");

    const btnLogin  = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const userPill  = document.getElementById("userPill");
    const userEmail = document.getElementById("userEmail");

    const adminPanel  = document.getElementById("adminPanel");
    const adminTitleText = document.getElementById("adminTitleText");
    const adminStatus = document.getElementById("adminStatus");
    const adminHint = document.getElementById("adminHint");

    const fName   = document.getElementById("fName");
    const fUrl    = document.getElementById("fUrl");
    const fDesc   = document.getElementById("fDesc");
    const fImgUrl = document.getElementById("fImgUrl");
    const fImgFile= document.getElementById("fImgFile");

    const fPrevImgUrl  = document.getElementById("fPrevImgUrl");
    const fPrevImgFile = document.getElementById("fPrevImgFile");

    const btnAdd  = document.getElementById("btnAdd");
    const btnClear= document.getElementById("btnClear");
    const btnCancelEdit = document.getElementById("btnCancelEdit");

    // players/time stepper
    const fPlayersLabel = document.getElementById("fPlayersLabel");
    const plMinDown = document.getElementById("plMinDown");
    const plMinUp   = document.getElementById("plMinUp");
    const plMaxDown = document.getElementById("plMaxDown");
    const plMaxUp   = document.getElementById("plMaxUp");

    const fTimeLabel = document.getElementById("fTimeLabel");
    const tmDown = document.getElementById("tmDown");
    const tmUp   = document.getElementById("tmUp");

    // tags
    const fTagInput = document.getElementById("fTagInput");
    const btnTagAdd = document.getElementById("btnTagAdd");
    const selectedTagsEl = document.getElementById("selectedTags");
    const tagSuggestionsEl = document.getElementById("tagSuggestions");

    // auth modal
    const authModalOverlay = document.getElementById("authModalOverlay");
    const tabLogin  = document.getElementById("tabLogin");
    const tabSignup = document.getElementById("tabSignup");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const btnAuthDo = document.getElementById("btnAuthDo");
    const authEmail = document.getElementById("authEmail");
    const authPass  = document.getElementById("authPass");
    const authErr   = document.getElementById("authErr");
    const authModeNote = document.getElementById("authModeNote");

    // password modal (NOW PLAY)
    const pwModalOverlay = document.getElementById("pwModalOverlay");
    const btnPwClose  = document.getElementById("btnPwClose");
    const btnPwCancel = document.getElementById("btnPwCancel");
    const btnPwOk     = document.getElementById("btnPwOk");
    const pwInput     = document.getElementById("pwInput");
    const pwErr       = document.getElementById("pwErr");
    const pwTargetNote= document.getElementById("pwTargetNote");

    // =========================
    // âœ… State
    // =========================
    let authMode = "login";
    let currentUser = null;

    let dbGames = [];
    let firebaseReady = false;
    let auth = null;
    let db = null;
    let gamesRef = null;

    // âœ… ã‚¿ã‚°è¾æ›¸
    let tagsRef = null;
    let dbTags = [];
    let dbTagsMap = {};
    let deletingTagBusy = false;

    // âœ… NOW PLAY ã‚’DBã§åŒæœŸï¼ˆã‚¹ãƒãƒ›ã§æ›´æ–°ã•ã‚Œãªã„å•é¡Œå¯¾ç­–ï¼‰
    let nowPlayRef = null;     // db.ref("nowPlay/current")
    let nowPlayUnsub = false;

    // âœ… form state
    let formMinPlayers = 3;
    let formMaxPlayers = 6;
    let formTimeMin = 20;
    let formTags = [];

    // âœ… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    let editingId = null;
    let editingOriginal = null;

    // âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ä¸¦ã¹æ›¿ãˆ
    let draggingSlot = null;

    // âœ… é¸æŠä¸­ã‚¿ã‚°ã®ä¸¦ã¹æ›¿ãˆ
    let draggingTagEl = null;

    // âœ… secondframe ã‚¯ãƒªãƒƒã‚¯ vs ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šç”¨
    const SF_CLICK = { active:false, moved:false, startX:0, startY:0, movedDist:0, downTime:0 };
    const SF_MOVE_PX = 10;
    const SF_TIME_MS = 450;

    // âœ… ã‚¿ãƒƒãƒ—ç›´å¾Œã®ã€Œghost clickã€å¯¾ç­–
    let _suppressClickUntil = 0;
    function suppressNextClick(ms=450){
      _suppressClickUntil = Date.now() + ms;
    }
    function isSuppressedClick(){
      return Date.now() < _suppressClickUntil;
    }

    // âœ… NOW PLAY state
    let nowPlay = null; // {gid,url,previewImg,hhmm,setAt,name, updatedAt?}
    let pendingNowPlayGame = null; // {gid,url,previewImg,name}

    // âœ… long-press detector for setting NOW PLAY
    const LP = { active:false, moved:false, startX:0, startY:0, timer:0, slot:null };
    const LP_MS = 650;
    const LP_MOVE = 12;

    // =========================
    // âœ… UI helpers
    // =========================
    function showModal(open){
      authModalOverlay.classList.toggle("show", !!open);
      authModalOverlay.setAttribute("aria-hidden", open ? "false" : "true");
      if(open){
        authErr.classList.remove("show");
        authErr.textContent = "";
        try{
          const cached = localStorage.getItem(LS_AUTH_EMAIL) || "";
          if(cached && !authEmail.value) authEmail.value = cached;
        }catch(_){}
        setTimeout(() => authEmail.focus(), 50);
      }
    }

    function setAuthMode(mode){
      authMode = mode;
      tabLogin.classList.toggle("active", mode === "login");
      tabSignup.classList.toggle("active", mode === "signup");
      btnAuthDo.textContent = (mode === "login") ? "ãƒ­ã‚°ã‚¤ãƒ³" : "æ–°è¦ç™»éŒ²";
      authModeNote.textContent = (mode === "login")
        ? "æ–°è¦ç™»éŒ²ãŒå¿…è¦ãªã‚‰ã€Œæ–°è¦ç™»éŒ²ã€ã‚¿ãƒ–ã¸ã€‚"
        : "ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹ãªã‚‰ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¿ãƒ–ã¸ã€‚";
      authErr.classList.remove("show");
      authErr.textContent = "";
    }

    function setAdminStatus(msg, type){
      adminStatus.textContent = msg || "";
      adminStatus.classList.remove("ok","err");
      if(type) adminStatus.classList.add(type);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeUrl(u){
      const s = (u || "").trim();
      if(!s) return "";
      if(!/^https?:\/\//i.test(s)) return "https://" + s;
      return s;
    }

    function clamp(n, min, max){
      return Math.max(min, Math.min(max, n));
    }

    function normTag(s){
      let t = String(s || "").trim();
      if(!t) return "";
      t = t.replace(/^#+/, "");
      t = t.replace(/\s+/g, " ");
      t = t.slice(0, 24);
      return t;
    }

    function tagKey(tag){
      return String(tag || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ")
        .replace(/[.#$/\[\]]/g, "");
    }

    function hasTag(t){
      const key = String(t || "").toLowerCase();
      return formTags.some(x => String(x).toLowerCase() === key);
    }

    function addTagToForm(t){
      const tag = normTag(t);
      if(!tag) return;
      if(hasTag(tag)) return;
      formTags.push(tag);
      renderTagsUI();
    }

    function removeTagFromForm(t){
      const key = String(t || "").toLowerCase();
      formTags = formTags.filter(x => String(x).toLowerCase() !== key);
      renderTagsUI();
    }

    function toggleTag(t){
      const tag = normTag(t);
      if(!tag) return;
      if(hasTag(tag)) removeTagFromForm(tag);
      else addTagToForm(tag);
    }

    function renderPlayersTimeLabels(){
      fPlayersLabel.textContent = `ğŸ‘¤${formMinPlayers}~${formMaxPlayers}`;
      fTimeLabel.textContent = `âŒš${formTimeMin}m`;
    }

    function computeAllTags(){
      const pool = [];
      for(const t of (dbTags || [])){
        const tt = normTag(t);
        if(tt) pool.push(tt);
      }
      const merged = [...seedGames, ...dbGames];
      for(const g of merged){
        const tags = Array.isArray(g?.tags) ? g.tags : [];
        for(const t of tags){
          const tt = normTag(t);
          if(tt) pool.push(tt);
        }
      }
      const seen = new Set();
      const out = [];
      for(const t of pool){
        const k = t.toLowerCase();
        if(seen.has(k)) continue;
        seen.add(k);
        out.push(t);
      }
      return out.slice(0, 80);
    }

    function renderTagsUI(){
      selectedTagsEl.innerHTML = formTags.length
        ? formTags.map(t => {
            const enc = encodeURIComponent(t);
            return `
              <span class="tagPickChip on" draggable="true" data-tagval="${escapeHtml(enc)}" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ / ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤">
                ${escapeHtml(t)} <span class="x">Ã—</span>
              </span>
            `;
          }).join("")
        : `<span style="opacity:.55;font-size:12px;">ï¼ˆæœªé¸æŠï¼‰</span>`;

      const sugg = computeAllTags();
      tagSuggestionsEl.innerHTML = sugg.length
        ? sugg.map(t => {
            const on = hasTag(t);
            const k = tagKey(t);
            const canDelete = !!currentUser && !!k && !!dbTagsMap[k];
            return `
              <span class="tagPickChip ${on ? "on" : ""}" data-tag="${escapeHtml(t)}" title="ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ /è§£é™¤">
                ${escapeHtml(t)}${on ? `<span class="x">Ã—</span>` : ""}
                ${canDelete ? `<span class="del" data-del="${escapeHtml(k)}" title="è¾æ›¸ã‹ã‚‰å‰Šé™¤">ğŸ—‘</span>` : ""}
              </span>
            `;
          }).join("")
        : `<span style="opacity:.55;font-size:12px;">ï¼ˆã¾ã ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</span>`;
    }

    function syncDescHeights(){
      if(!grid) return;
      const boxes = [...grid.querySelectorAll(".descBox")];
      if(!boxes.length) return;

      for(const b of boxes) b.style.minHeight = "0px";

      const groups = new Map();
      for(const b of boxes){
        const top = Math.round(b.getBoundingClientRect().top);
        if(!groups.has(top)) groups.set(top, []);
        groups.get(top).push(b);
      }

      for(const arr of groups.values()){
        let maxH = 0;
        for(const b of arr) maxH = Math.max(maxH, b.scrollHeight);
        for(const b of arr) b.style.minHeight = maxH + "px";
      }
    }

    function syncSlotHeights(){
      if(!grid) return;
      const slots = [...grid.querySelectorAll(".slot")];
      if(!slots.length) return;

      for(const s of slots) s.style.minHeight = "0px";

      const groups = new Map();
      for(const s of slots){
        const top = Math.round(s.getBoundingClientRect().top);
        if(!groups.has(top)) groups.set(top, []);
        groups.get(top).push(s);
      }

      for(const arr of groups.values()){
        let maxH = 0;
        for(const s of arr) maxH = Math.max(maxH, s.offsetHeight);
        for(const s of arr) s.style.minHeight = maxH + "px";
      }
    }

    function syncAllHeights(){
      syncDescHeights();
      syncSlotHeights();
    }

    let _syncT = 0;
    function requestSyncLayout(){
      cancelAnimationFrame(_syncT);
      _syncT = requestAnimationFrame(() => syncAllHeights());
    }

    function toast(text, ms=900){
      dropHint.textContent = text;
      dropHint.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => {
        if(!draggingSlot) dropHint.classList.remove("show");
      }, ms);
    }

    // =========================
    // âœ… NOW PLAY helpers
    // =========================
    function getHHMMNow(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return hh + mm;
    }

    function appendRoomParam(url, hhmm){
      const raw = String(url || "").trim();
      if(!raw) return raw;
      try{
        const u = new URL(raw);
        u.searchParams.set("room", hhmm);
        // âœ… iOS Safariå¯¾ç­–ï¼šåŒã˜URLã‚’é€£ç¶šã§é–‹ã„ã¦ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã‚‰ãªã„ã‚ˆã†ã«è»½ã„bustã‚’ä»˜ã‘ã‚‹
        u.searchParams.set("_t", String(Date.now()));
        return u.toString();
      }catch(_){
        const hasQ = raw.includes("?");
        const sep = hasQ ? "&" : "?";
        return raw + sep + "room=" + encodeURIComponent(hhmm) + "&_t=" + Date.now();
      }
    }

    function loadNowPlay(){
      try{
        const s = localStorage.getItem(LS_NOW_PLAY);
        if(!s) return null;
        const obj = JSON.parse(s);
        if(!obj || !obj.url || !obj.previewImg || !obj.hhmm) return null;
        return obj;
      }catch(_){
        return null;
      }
    }

    function saveNowPlayLocal(obj){
      nowPlay = obj || null;
      try{
        if(nowPlay) localStorage.setItem(LS_NOW_PLAY, JSON.stringify(nowPlay));
        else localStorage.removeItem(LS_NOW_PLAY);
      }catch(_){}
    }

    // âœ… DBã«ä¿å­˜ï¼ˆå…¨ç«¯æœ«åŒæœŸï¼‰
    async function saveNowPlayToDB(obj){
      if(!firebaseReady || !db) throw new Error("FirebaseãŒåˆæœŸåŒ–ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
      if(!currentUser) throw new Error("NOW PLAY ã®è¨­å®šã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");

      const payload = {
        gid: obj?.gid || "",
        url: obj?.url || "",
        previewImg: obj?.previewImg || "",
        name: obj?.name || "",
        hhmm: obj?.hhmm || "",
        setAt: Number(obj?.setAt || 0) || 0,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
        updatedBy: currentUser.uid,
        updatedByEmail: currentUser.email || ""
      };
      await db.ref("nowPlay").child("current").set(payload);
    }

    // âœ… DBã®NOW PLAYã‚’ç›£è¦–ï¼ˆã‚¹ãƒãƒ›ã§æ›´æ–°ã•ã‚Œãªã„ï¼ç«¯æœ«é–“ã§åŒæœŸã—ãªã„å•é¡Œã‚’è§£æ±ºï¼‰
    function startNowPlayListener(){
      if(!firebaseReady || !db) return;
      if(nowPlayRef) return;

      nowPlayRef = db.ref("nowPlay/current");
      nowPlayRef.on("value", (snap) => {
        const v = snap.val();
        if(!v || !v.url || !v.previewImg || !v.hhmm){
          // DBå´ãŒæœªè¨­å®šãªã‚‰ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ç¶­æŒï¼ˆãŸã ã—ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚ç„¡ã‘ã‚Œã°ç©ºï¼‰
          const local = loadNowPlay();
          saveNowPlayLocal(local);
          renderGrid();
          return;
        }

        const obj = {
          gid: v.gid || "",
          url: v.url || "",
          previewImg: v.previewImg || "",
          name: v.name || "",
          hhmm: String(v.hhmm || ""),
          setAt: Number(v.setAt || 0) || 0,
          updatedAt: Number(v.updatedAt || 0) || 0
        };

        // âœ… ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ä¿é™ºï¼‰
        saveNowPlayLocal(obj);
        renderGrid();
      }, (_err) => {
        // å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã§ç¶™ç¶š
        const local = loadNowPlay();
        saveNowPlayLocal(local);
        renderGrid();
      });
    }

    function showPwModal(open){
      pwModalOverlay.classList.toggle("show", !!open);
      pwModalOverlay.setAttribute("aria-hidden", open ? "false" : "true");
      pwErr.classList.remove("show");
      pwErr.textContent = "";
      pwInput.value = "";
      if(open){
        setTimeout(() => pwInput.focus(), 40);
      }else{
        pendingNowPlayGame = null;
      }
    }

    function openPwForGame(g){
      pendingNowPlayGame = g;
      pwTargetNote.textContent = `ã€Œ${g?.name || "ï¼ˆç„¡é¡Œï¼‰"}ã€ã‚’å…ˆé ­ã® NOW PLAY æ ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚`;
      showPwModal(true);
    }

    async function confirmPw(){
      const val = (pwInput.value || "").trim();
      if(val !== "2225"){
        pwErr.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
        pwErr.classList.add("show");
        return;
      }
      if(!pendingNowPlayGame || !pendingNowPlayGame.url || !pendingNowPlayGame.previewImg){
        pwErr.textContent = "å¯¾è±¡ã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚";
        pwErr.classList.add("show");
        return;
      }

      // âœ… é‡è¦ï¼šå…¨ç«¯æœ«åŒæœŸã®ãŸã‚ã€è¨­å®šã¯ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã«ã™ã‚‹
      if(!currentUser){
        pwErr.textContent = "NOW PLAY ã‚’å…¨ç«¯æœ«ã«åæ˜ ã™ã‚‹ãŸã‚ã€å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
        pwErr.classList.add("show");
        return;
      }

      const hhmm = getHHMMNow();
      const obj = {
        gid: pendingNowPlayGame.gid || "",
        url: pendingNowPlayGame.url,
        previewImg: pendingNowPlayGame.previewImg,
        name: pendingNowPlayGame.name || "",
        hhmm,
        setAt: Date.now()
      };

      try{
        // âœ… ãƒ­ãƒ¼ã‚«ãƒ«å³åæ˜ 
        saveNowPlayLocal(obj);
        renderGrid();

        // âœ… DBã¸ä¿å­˜ï¼ˆã‚¹ãƒãƒ›å«ã‚å…¨ç«¯æœ«æ›´æ–°ï¼‰
        await saveNowPlayToDB(obj);

        showPwModal(false);
        toast(`NOW PLAY ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ âœ…`, 900);

        // âœ… è¨­å®šè€…ã¯OKå¾Œã«è‡ªå‹•ã§ãƒªãƒ³ã‚¯ã¸ç§»å‹•ï¼ˆroomä»˜ä¸ + iOSå¯¾ç­– _tï¼‰
        const openUrl = appendRoomParam(obj.url, obj.hhmm);
        window.open(openUrl, "_blank", "noopener,noreferrer");
      }catch(err){
        pwErr.textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err?.message || err);
        pwErr.classList.add("show");
      }
    }

    // =========================
    // âœ… secondframe ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º/éè¡¨ç¤º
    // =========================
    function closeAllSfOverlays(){
      const overlays = [...grid.querySelectorAll(".sfOverlay.show")];
      for(const ov of overlays){
        ov.classList.remove("show");
        ov.setAttribute("aria-hidden","true");
      }
    }

    function openSfOverlayForSlot(slotEl){
      if(!slotEl) return;
      const hasPrev = slotEl.getAttribute("data-hasprev")==="1";
      if(!hasPrev) return;

      closeAllSfOverlays();
      const ov = slotEl.querySelector(".sfOverlay");
      if(!ov) return;

      ov.classList.add("show");
      ov.setAttribute("aria-hidden","false");
    }

    // =========================
    // âœ… Slot HTML
    // =========================
    function specialSlotHTML(index){
      const has = !!(nowPlay && nowPlay.url && nowPlay.previewImg && nowPlay.hhmm);
      return `
        <article class="slot special" aria-label="slot-${index+1}"
          data-special="1"
          data-gameid=""
          data-my="0"
          data-hasprev="0"
          draggable="false">
          <div class="nowPlayArea" aria-label="now-play-area">
            ${has ? `<img src="${escapeHtml(nowPlay.previewImg)}" alt="">` : ``}
            <div class="nowPlayText" aria-hidden="true">NOW PLAY!</div>
            ${has ? `<div class="nowPlayClickLayer" data-action="nowPlayOpen" title="ã‚¯ãƒªãƒƒã‚¯ã§é–‹å§‹"></div>` : ``}
          </div>
        </article>
      `;
    }

    function slotHTML(g = {}, index, isMyGame){
      const {name, desc, url, img, previewImg, players, timeMin, tags, id} = g || {};
      const hasGame = !!url;

      const title = hasGame
        ? `<span class="gameTitle">${escapeHtml(name || "ï¼ˆç„¡é¡Œï¼‰")}</span>`
        : `<span class="gameTitle" style="opacity:.45;"></span>`;

      const p = players && (players.min || players.max) ? players : null;
      const minP = p ? (p.min ?? "") : "";
      const maxP = p ? (p.max ?? "") : "";
      const showPlayers = (minP !== "" && maxP !== "") ? `ğŸ‘¤${minP}~${maxP}` : "";

      const tm = Number.isFinite(Number(timeMin)) ? Number(timeMin) : null;
      const showTime = (tm && tm > 0) ? `âŒš${tm}m` : "";

      const metaRow = (hasGame && (showPlayers || showTime))
        ? `<div class="metaRow">
             ${showPlayers ? `<span class="metaPill">${escapeHtml(showPlayers)}</span>` : ""}
             ${showTime ? `<span class="metaPill">${escapeHtml(showTime)}</span>` : ""}
           </div>`
        : "";

      const tagArr = Array.isArray(tags) ? tags.map(normTag).filter(Boolean).slice(0, 10) : [];
      const tagRow = (hasGame && tagArr.length)
        ? `<div class="tagRow">${tagArr.map(t => `<span class="tagChip">${escapeHtml(t)}</span>`).join("")}</div>`
        : "";

      const description = hasGame
        ? `<p class="desc">${escapeHtml(desc || "")}</p>`
        : `<p class="desc" style="opacity:.45;">Loading...</p>`;

      const editBtn = (hasGame && currentUser && isMyGame && id)
        ? `<button class="cardEditBtn" data-action="editGame" data-id="${escapeHtml(id)}" title="ã“ã®ã‚²ãƒ¼ãƒ ã‚’ç·¨é›†">ç·¨é›†</button>`
        : "";

      const imgHTML = (hasGame && img)
        ? `
          <div class="imgBase" aria-hidden="true">
            <img class="previewImg" src="${escapeHtml(img)}" alt="">
          </div>
        `
        : `
          <div class="imgBase" aria-hidden="true">
            <div class="empty"></div>
          </div>
        `;

      const hasPrev = !!(hasGame && previewImg);
      const prevLink = (hasPrev && hasGame)
        ? `
          <a class="sfImgLink" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">
            <img src="${escapeHtml(previewImg)}" alt="">
          </a>
        `
        : "";

      return `
        <article class="slot" aria-label="slot-${index+1}"
          data-special="0"
          data-gameid="${escapeHtml(id || "")}"
          data-name="${escapeHtml(name || "")}"
          data-url="${escapeHtml(url || "")}"
          data-preview="${escapeHtml(previewImg || "")}"
          data-my="${isMyGame ? "1":"0"}"
          data-hasprev="${hasPrev ? "1":"0"}"
          draggable="${(currentUser && isMyGame && id) ? "true" : "false"}">

          <div class="secondframe" data-action="sf" aria-label="secondframe"></div>

          <div class="sfOverlay" aria-hidden="true">
            <div class="sfInner">
              ${prevLink}
              <button class="sfClose" data-action="sfClose" aria-label="close">Ã—</button>
            </div>
          </div>

          <div class="infoBox">
            <div class="topRow">
              <div class="imgCol">
                ${imgHTML}
              </div>
              <div class="metaCol">
                ${title}
                ${metaRow}
                ${tagRow}
              </div>
            </div>

            <div class="descBox">
              ${description}
            </div>
          </div>

          ${editBtn}
        </article>
      `;
    }

    function updateAuthUI(){
      const signedIn = !!currentUser;

      btnLogin.classList.toggle("hidden", signedIn);
      userPill.classList.toggle("hidden", !signedIn);
      adminPanel.classList.toggle("hidden", !signedIn);

      if(signedIn){
        userEmail.textContent = currentUser.email || "(no email)";
        setAdminStatus("", null);
      }else{
        setAdminStatus("ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚’è¿½åŠ ã§ãã¾ã™", null);
      }
      renderGrid();
      renderTagsUI();
    }

    function setEditMode(on){
      btnCancelEdit.style.display = on ? "" : "none";
      btnAdd.textContent = on ? "æ›´æ–°" : "è¿½åŠ ";
      adminTitleText.textContent = on ? "ã‚²ãƒ¼ãƒ ç·¨é›†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ï¼‰" : "ã‚²ãƒ¼ãƒ è¿½åŠ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ï¼‰";
      adminHint.textContent = on
        ? "æ›´æ–°ã™ã‚‹ã¨Realtime DBã¸åæ˜ ï¼ˆç”»åƒ/ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¯æœªå…¥åŠ›ãªã‚‰å¤‰æ›´ã—ã¾ã›ã‚“ï¼‰"
        : "è¿½åŠ ã™ã‚‹ã¨Realtime DBã¸æ›¸ãè¾¼ã¿â†’ä¸€è¦§ã«å³åæ˜ ";
    }

    function exitEditMode(){
      editingId = null;
      editingOriginal = null;
      setEditMode(false);
      setAdminStatus("", null);
    }

    // =========================
    // âœ… Firebase init & listeners
    // =========================
    function friendlyAuthError(e){
      const code = e?.code || "";
      const msg  = e?.message || String(e || "");

      if(code === "auth/invalid-email") return "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";
      if(code === "auth/missing-password") return "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      if(code === "auth/weak-password") return "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã„ã§ã™ï¼ˆ6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ï¼‰ã€‚";
      if(code === "auth/user-not-found") return "ã“ã®ãƒ¡ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„ï¼‰ã€‚";
      if(code === "auth/wrong-password") return "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
      if(code === "auth/email-already-in-use") return "ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰ã€‚";
      if(code === "auth/network-request-failed") return "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³/ãƒ–ãƒ­ãƒƒã‚¯ã®å¯èƒ½æ€§ï¼‰ã€‚";
      if(code === "auth/too-many-requests") return "è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
      if(code === "auth/operation-not-allowed") return "Firebaseå´ã§ã€Œãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€èªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚";

      const origin = location.origin;
      const protocol = location.protocol;
      const extra = (protocol === "file:" || origin === "null")
        ? "\n\nâ€» file:// ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã«ã‚ˆã£ã¦ã¯å¤–éƒ¨é€šä¿¡ãŒåˆ¶é™ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚"
        : "";

      return `ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${code ? `[${code}] ` : ""}${msg}${extra}`;
    }

    async function initFirebase(){
      try{
        if(!window.firebase) throw new Error("Firebase SDKã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");

        if(!firebase.apps || !firebase.apps.length){
          firebase.initializeApp(firebaseConfig);
        }

        auth = firebase.auth();
        db = firebase.database();

        try{
          await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        }catch(_){}

        firebaseReady = true;

        auth.onAuthStateChanged((user) => {
          currentUser = user || null;
          exitEditMode();
          updateAuthUI();

          startDbListener();
          startTagsListener();

          // âœ… NOW PLAY ã‚’DBã‹ã‚‰ç›£è¦–é–‹å§‹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ä¾å­˜ã—ãªã„èª­ã¿å–ã‚Šï¼‰
          startNowPlayListener();

          renderGrid();
          renderTagsUI();
        });

        renderGrid();
        updateAuthUI();

        // âœ… åˆæœŸã§ã‚‚ NOW PLAY ç›£è¦–ï¼ˆonAuthStateChangedå‰ã§ã‚‚OKï¼‰
        startNowPlayListener();
      }catch(err){
        firebaseReady = false;
        renderGrid();
        updateAuthUI();
        setAdminStatus("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + (err?.message || err), "err");
      }
    }

    function startDbListener(){
      if(gamesRef) return;

      gamesRef = db.ref("games");

      gamesRef.on("value", (snap) => {
        const arr = [];
        snap.forEach(child => {
          const v = child.val() || {};
          const players = v.players && typeof v.players === "object"
            ? { min: Number(v.players.min ?? 0) || 0, max: Number(v.players.max ?? 0) || 0 }
            : null;

          const tags = Array.isArray(v.tags) ? v.tags : [];

          arr.push({
            id: child.key,
            name: v.name || "",
            desc: v.desc || "",
            url: v.url || "",
            img: v.img || "",
            previewImg: v.previewImg || "",
            players: players ? {min: players.min, max: players.max} : null,
            timeMin: Number(v.timeMin ?? 0) || 0,
            tags,
            createdAt: Number(v.createdAt ?? 0) || 0,
            createdBy: v.createdBy || "",
            createdByEmail: v.createdByEmail || "",
            orderIndex: Number(v.orderIndex ?? 0) || 0
          });
        });

        dbGames = arr;

        // âœ… DBã®nowPlayãŒgidã‚’æŒã£ã¦ã„ã¦ã€ã‚²ãƒ¼ãƒ åãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºã ã‘è¿½å¾“ï¼ˆä»»æ„ï¼‰
        if(nowPlay && nowPlay.gid){
          const hit = dbGames.find(g => g.id === nowPlay.gid);
          if(hit && hit.name && nowPlay.name !== hit.name){
            nowPlay.name = hit.name;
            saveNowPlayLocal(nowPlay);
          }
        }

        renderGrid();
        renderTagsUI();
      }, (err) => {
        dbGames = [];
        renderGrid();
        setAdminStatus("DBèª­ã¿è¾¼ã¿æ¨©é™ã‚¨ãƒ©ãƒ¼: " + (err?.message || err), "err");
      });
    }

    function startTagsListener(){
      if(tagsRef) return;

      tagsRef = db.ref("tags");
      tagsRef.on("value", (snap) => {
        const out = [];
        const map = {};
        snap.forEach(child => {
          const v = child.val() || {};
          const key = child.key || "";
          let name = "";
          if(typeof v === "string"){
            name = normTag(v);
          }else{
            name = normTag(v.name || key || "");
          }
          if(name){
            out.push(name);
            map[key] = name;
          }
        });

        const seen = new Set();
        dbTags = out.filter(Boolean).filter(t => {
          const k = t.toLowerCase();
          if(seen.has(k)) return false;
          seen.add(k);
          return true;
        });

        dbTagsMap = map;

        renderTagsUI();
      }, (_err) => {
        dbTags = [];
        dbTagsMap = {};
        renderTagsUI();
      });
    }

    // =========================
    // âœ… tags: persist
    // =========================
    async function upsertTagToDB(tag){
      const t = normTag(tag);
      if(!t) return;
      if(!firebaseReady || !db) return;
      if(!currentUser) throw new Error("ã‚¿ã‚°è¿½åŠ ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");

      const k = tagKey(t);
      if(!k) return;

      if((dbTags || []).some(x => String(x).toLowerCase() === t.toLowerCase())) return;

      const payload = {
        name: t,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        createdBy: currentUser.uid,
        createdByEmail: currentUser.email || ""
      };

      await db.ref("tags").child(k).set(payload);
    }

    async function upsertTagsToDB(tags){
      const arr = (tags || []).map(normTag).filter(Boolean);
      if(!arr.length) return;
      if(!currentUser) return;

      const updates = {};
      for(const t of arr){
        const k = tagKey(t);
        if(!k) continue;
        if((dbTags || []).some(x => String(x).toLowerCase() === t.toLowerCase())) continue;
        updates[k] = {
          name: t,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          createdBy: currentUser.uid,
          createdByEmail: currentUser.email || ""
        };
      }
      if(Object.keys(updates).length){
        await db.ref("tags").update(updates);
      }
    }

    async function deleteTagFromDB(tagKeyStr){
      if(!firebaseReady || !db) throw new Error("FirebaseãŒåˆæœŸåŒ–ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
      if(!currentUser) throw new Error("ã‚¿ã‚°å‰Šé™¤ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
      const key = String(tagKeyStr || "").trim();
      if(!key) return;

      if(deletingTagBusy) return;
      deletingTagBusy = true;

      try{
        const name = dbTagsMap?.[key] || key;
        const ok = window.confirm(`ã‚¿ã‚°è¾æ›¸ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚\n\nã€Œ${name}ã€\n\nâ€» æ—¢ã«ç™»éŒ²æ¸ˆã¿ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚°è¡¨ç¤ºã¯æ®‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆè¾æ›¸ã‹ã‚‰æ¶ˆãˆã‚‹ã ã‘ï¼‰ã€‚\nå‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
        if(!ok) return;

        await db.ref("tags").child(key).remove();

        const lower = String(name).toLowerCase();
        formTags = (formTags || []).filter(t => String(t).toLowerCase() !== lower);
        renderTagsUI();

        setAdminStatus("ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", "ok");
        setTimeout(() => setAdminStatus("", null), 900);
      }finally{
        deletingTagBusy = false;
      }
    }

    // =========================
    // âœ… Add / Update game
    // =========================
    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
        r.readAsDataURL(file);
      });
    }

    function resetFormState(){
      formMinPlayers = 3;
      formMaxPlayers = 6;
      formTimeMin = 20;
      formTags = [];
      renderPlayersTimeLabels();
      renderTagsUI();
    }

    function clearForm(){
      fName.value = "";
      fUrl.value = "";
      fDesc.value = "";
      fImgUrl.value = "";
      fImgFile.value = "";

      fPrevImgUrl.value = "";
      fPrevImgFile.value = "";

      fTagInput.value = "";
      resetFormState();
      setAdminStatus("", null);
      exitEditMode();
    }

    function getNextOrderIndexForUid(uid){
      const mine = dbGames.filter(g => g && g.createdBy === uid);
      const vals = mine.map(g => Number(g.orderIndex||0)).filter(n => Number.isFinite(n) && n > 0);
      const max = vals.length ? Math.max(...vals) : 0;
      return max + 1;
    }

    async function saveGame(){
      if(editingId) return await updateGame(editingId);
      return await addGame();
    }

    async function addGame(){
      try{
        if(!firebaseReady) throw new Error("FirebaseãŒåˆæœŸåŒ–ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
        if(!currentUser) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");

        const name = (fName.value || "").trim();
        const desc = (fDesc.value || "").trim();
        const url  = normalizeUrl(fUrl.value || "");

        const imgUrl = (fImgUrl.value || "").trim();
        const prevUrl = (fPrevImgUrl.value || "").trim();

        if(!name) throw new Error("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        if(!url)  throw new Error("ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        let img = "";
        const file = fImgFile.files && fImgFile.files[0];
        if(file){
          img = await readFileAsDataURL(file);
        }else if(imgUrl){
          img = imgUrl;
        }

        let previewImg = "";
        const pfile = fPrevImgFile.files && fPrevImgFile.files[0];
        if(pfile){
          previewImg = await readFileAsDataURL(pfile);
        }else if(prevUrl){
          previewImg = prevUrl;
        }

        formMinPlayers = clamp(formMinPlayers, 1, 12);
        formMaxPlayers = clamp(formMaxPlayers, 1, 12);
        if(formMinPlayers > formMaxPlayers) formMinPlayers = formMaxPlayers;

        formTimeMin = clamp(formTimeMin, 5, 240);

        const tags = (formTags || []).map(normTag).filter(Boolean).slice(0, 20);

        setAdminStatus("ä¿å­˜ä¸­...", null);

        const newRef = db.ref("games").push();
        const nextOrder = getNextOrderIndexForUid(currentUser.uid);

        const payload = {
          name,
          desc,
          url,
          img,
          previewImg,
          players: { min: formMinPlayers, max: formMaxPlayers },
          timeMin: formTimeMin,
          tags,
          orderIndex: nextOrder,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          createdBy: currentUser.uid,
          createdByEmail: currentUser.email || ""
        };

        await newRef.set(payload);
        await upsertTagsToDB(tags);

        setAdminStatus("è¿½åŠ ã—ã¾ã—ãŸï¼", "ok");
        clearForm();
      }catch(err){
        const msg = err?.message || String(err || "");
        setAdminStatus(msg, "err");
      }
    }

    async function updateGame(gameId){
      try{
        if(!firebaseReady) throw new Error("FirebaseãŒåˆæœŸåŒ–ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
        if(!currentUser) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        if(!editingOriginal) throw new Error("ç·¨é›†å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

        if(editingOriginal.createdBy !== currentUser.uid){
          throw new Error("è‡ªåˆ†ãŒç™»éŒ²ã—ãŸã‚²ãƒ¼ãƒ ã ã‘ç·¨é›†ã§ãã¾ã™ã€‚");
        }

        const name = (fName.value || "").trim();
        const desc = (fDesc.value || "").trim();
        const url  = normalizeUrl(fUrl.value || "");

        const imgUrl = (fImgUrl.value || "").trim();
        const prevUrl = (fPrevImgUrl.value || "").trim();

        if(!name) throw new Error("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        if(!url)  throw new Error("ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        let img = editingOriginal.img || "";
        const file = fImgFile.files && fImgFile.files[0];
        if(file){
          img = await readFileAsDataURL(file);
        }else if(imgUrl){
          img = imgUrl;
        }

        let previewImg = editingOriginal.previewImg || "";
        const pfile = fPrevImgFile.files && fPrevImgFile.files[0];
        if(pfile){
          previewImg = await readFileAsDataURL(pfile);
        }else if(prevUrl){
          previewImg = prevUrl;
        }

        formMinPlayers = clamp(formMinPlayers, 1, 12);
        formMaxPlayers = clamp(formMaxPlayers, 1, 12);
        if(formMinPlayers > formMaxPlayers) formMinPlayers = formMaxPlayers;

        formTimeMin = clamp(formTimeMin, 5, 240);

        const tags = (formTags || []).map(normTag).filter(Boolean).slice(0, 20);

        setAdminStatus("æ›´æ–°ä¸­...", null);

        const patch = {
          name,
          desc,
          url,
          img,
          previewImg,
          players: { min: formMinPlayers, max: formMaxPlayers },
          timeMin: formTimeMin,
          tags,
          updatedAt: firebase.database.ServerValue.TIMESTAMP,
          updatedBy: currentUser.uid,
          updatedByEmail: currentUser.email || ""
        };

        await db.ref("games").child(gameId).update(patch);
        await upsertTagsToDB(tags);

        setAdminStatus("æ›´æ–°ã—ã¾ã—ãŸï¼", "ok");
        clearForm();
      }catch(err){
        const msg = err?.message || String(err || "");
        setAdminStatus(msg, "err");
      }
    }

    function startEdit(gameId){
      if(!currentUser) return;

      const g = dbGames.find(x => x.id === gameId);
      if(!g){
        setAdminStatus("ç·¨é›†å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", "err");
        return;
      }
      if(g.createdBy !== currentUser.uid){
        setAdminStatus("è‡ªåˆ†ãŒç™»éŒ²ã—ãŸã‚²ãƒ¼ãƒ ã ã‘ç·¨é›†ã§ãã¾ã™ã€‚", "err");
        return;
      }

      editingId = gameId;
      editingOriginal = g;

      fName.value = g.name || "";
      fUrl.value = g.url || "";
      fDesc.value = g.desc || "";
      fImgUrl.value = "";
      fImgFile.value = "";

      fPrevImgUrl.value = "";
      fPrevImgFile.value = "";

      formMinPlayers = clamp(Number(g.players?.min ?? 3) || 3, 1, 12);
      formMaxPlayers = clamp(Number(g.players?.max ?? 6) || 6, 1, 12);
      if(formMinPlayers > formMaxPlayers) formMinPlayers = formMaxPlayers;

      formTimeMin = clamp(Number(g.timeMin ?? 20) || 20, 5, 240);
      formTimeMin = Math.round(formTimeMin / 5) * 5;
      formTimeMin = clamp(formTimeMin, 5, 240);

      formTags = Array.isArray(g.tags) ? g.tags.map(normTag).filter(Boolean).slice(0, 20) : [];

      renderPlayersTimeLabels();
      renderTagsUI();

      setEditMode(true);
      setAdminStatus("ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šå†…å®¹ã‚’ç›´ã—ã¦ã€Œæ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚", null);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // =========================
    // âœ… ã€é‡è¦ã€‘ç«¯æœ«å·®ã‚¼ãƒ­ã®ã€Œå®‰å®šã‚½ãƒ¼ãƒˆã€
    // =========================
    function stableStr(s){ return String(s||""); }
    function stableIdTie(a,b){
      const A = stableStr(a?.id);
      const B = stableStr(b?.id);
      if(A < B) return -1;
      if(A > B) return 1;
      return 0;
    }

    function getPrimaryOwnerUid(){
      const cnt = new Map();
      for(const g of dbGames){
        const u = stableStr(g?.createdBy);
        if(!u) continue;
        cnt.set(u, (cnt.get(u)||0) + 1);
      }
      let bestUid = "";
      let bestN = 0;
      for(const [u,n] of cnt.entries()){
        if(n > bestN){
          bestN = n;
          bestUid = u;
        }else if(n === bestN && n > 0){
          if(bestUid === "" || u < bestUid) bestUid = u;
        }
      }
      return bestUid;
    }

    function sortByOrderIndexAscThenFallback(a,b){
      const ao = Number(a?.orderIndex||0);
      const bo = Number(b?.orderIndex||0);
      const aHas = Number.isFinite(ao) && ao > 0;
      const bHas = Number.isFinite(bo) && bo > 0;

      if(aHas && bHas){
        if(ao !== bo) return ao - bo;
        const at = Number(a?.createdAt||0);
        const bt = Number(b?.createdAt||0);
        if(at !== bt) return bt - at;
        return stableIdTie(a,b);
      }
      if(aHas && !bHas) return -1;
      if(!aHas && bHas) return 1;

      const at = Number(a?.createdAt||0);
      const bt = Number(b?.createdAt||0);
      if(at !== bt) return bt - at;
      return stableIdTie(a,b);
    }

    function sortByCreatedAtDescThenId(a,b){
      const at = Number(a?.createdAt||0);
      const bt = Number(b?.createdAt||0);
      if(at !== bt) return bt - at;
      return stableIdTie(a,b);
    }

    function makeDisplayGames(){
      const primaryUid = getPrimaryOwnerUid();

      const all = [...dbGames];

      const primary = primaryUid ? all.filter(g => g.createdBy === primaryUid) : [];
      primary.sort(sortByOrderIndexAscThenFallback);

      const rest = primaryUid ? all.filter(g => g.createdBy !== primaryUid) : all;
      rest.sort(sortByCreatedAtDescThenId);

      return [...seedGames, ...primary, ...rest];
    }

    function renderGrid(){
      const merged = makeDisplayGames();

      const slots = Array.from({length: TOTAL_SLOTS}, (_, i) => {
        if(i === 0) return { __special:true };
        return merged[i - 1] ?? {};
      });

      grid.innerHTML = slots.map((g, i) => {
        if(i === 0) return specialSlotHTML(i);
        const isMyGame = !!currentUser && !!g?.id && g.createdBy === currentUser.uid;
        return slotHTML(g, i, isMyGame);
      }).join("");

      const imgs = [...grid.querySelectorAll("img.previewImg")];
      for(const im of imgs){
        if(im.complete) continue;
        im.addEventListener("load", requestSyncLayout, { once:true });
        im.addEventListener("error", requestSyncLayout, { once:true });
      }

      renderTagsUI();
      requestSyncLayout();
    }

    // =========================
    // âœ… ä¸¦ã¹æ›¿ãˆä¿å­˜ï¼ˆgames/{gid}/orderIndex ã‚’æ›´æ–°ï¼‰
    // =========================
    function getMySlotsInDom(){
      return [...grid.querySelectorAll(".slot[data-my='1']")];
    }

    function persistMyOrderToGames(){
      if(!currentUser || !db) return;

      const primaryUid = getPrimaryOwnerUid();
      if(primaryUid && currentUser.uid !== primaryUid){
        toast("ã“ã®ç«¯æœ«ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¡ã‚¤ãƒ³æ‰€æœ‰è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“", 1400);
        return;
      }

      const els = getMySlotsInDom();
      const ids = els
        .map(el => el.getAttribute("data-gameid") || "")
        .filter(Boolean);

      const updates = {};
      ids.forEach((id, idx) => {
        updates[`games/${id}/orderIndex`] = idx + 1;
      });

      toast("é †ç•ªã‚’ä¿å­˜ä¸­...");
      db.ref().update(updates).then(() => {
        toast("é †ç•ªã‚’ä¿å­˜ã—ã¾ã—ãŸ âœ…");
      }).catch(err => {
        toast("ä¿å­˜ã«å¤±æ•—: " + (err?.message || err), 1400);
      });
    }

    // =========================
    // âœ… Grid drag & dropï¼ˆã‚°ãƒªãƒƒãƒ‰å¯¾å¿œã®æŒ¿å…¥åˆ¤å®šï¼‰
    // =========================
    function getGridAfterElement(mySlots, x, y){
      const candidates = mySlots.filter(el => el !== draggingSlot);
      let best = null;
      let bestScore = Infinity;
      const BIG = 10000;

      for(const el of candidates){
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width/2;
        const cy = r.top  + r.height/2;

        const dy = cy - y;
        const dx = cx - x;

        const rowMajor = dy * BIG + dx;

        if(rowMajor >= 0){
          if(rowMajor < bestScore){
            bestScore = rowMajor;
            best = el;
          }
        }
      }
      return best;
    }

    // =========================
    // âœ… Auth actions
    // =========================
    async function doAuth(){
      try{
        if(!firebaseReady) throw new Error("FirebaseãŒåˆæœŸåŒ–ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
        authErr.classList.remove("show");
        authErr.textContent = "";

        const email = (authEmail.value || "").trim();
        const pass  = (authPass.value || "");

        if(!email) throw new Error("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        if(!pass)  throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        try{ localStorage.setItem(LS_AUTH_EMAIL, email); }catch(_){}

        if(authMode === "login"){
          await auth.signInWithEmailAndPassword(email, pass);
        }else{
          await auth.createUserWithEmailAndPassword(email, pass);
        }

        showModal(false);
      }catch(err){
        authErr.textContent = friendlyAuthError(err);
        authErr.classList.add("show");
      }
    }

    // =========================
    // âœ… Events
    // =========================
    btnLogin.addEventListener("click", () => { setAuthMode("login"); showModal(true); });
    btnLogout.addEventListener("click", async () => { try{ if(auth) await auth.signOut(); }catch(_){ } });

    tabLogin.addEventListener("click", () => setAuthMode("login"));
    tabSignup.addEventListener("click", () => setAuthMode("signup"));

    btnCloseModal.addEventListener("click", () => showModal(false));
    authModalOverlay.addEventListener("click", (e) => { if(e.target === authModalOverlay) showModal(false); });

    btnAuthDo.addEventListener("click", doAuth);
    authPass.addEventListener("keydown", (e) => { if(e.key === "Enter") doAuth(); });

    authEmail.addEventListener("input", () => {
      try{ localStorage.setItem(LS_AUTH_EMAIL, (authEmail.value||"").trim()); }catch(_){}
    });

    btnAdd.addEventListener("click", saveGame);
    btnClear.addEventListener("click", clearForm);
    btnCancelEdit.addEventListener("click", () => { clearForm(); setAdminStatus("ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚", null); });

    function bumpMin(delta){
      formMinPlayers = clamp(formMinPlayers + delta, 1, 12);
      if(formMinPlayers > formMaxPlayers) formMinPlayers = formMaxPlayers;
      renderPlayersTimeLabels();
    }
    function bumpMax(delta){
      formMaxPlayers = clamp(formMaxPlayers + delta, 1, 12);
      if(formMaxPlayers < formMinPlayers) formMaxPlayers = formMinPlayers;
      renderPlayersTimeLabels();
    }
    plMinDown.addEventListener("click", () => bumpMin(-1));
    plMinUp.addEventListener("click", () => bumpMin(+1));
    plMaxDown.addEventListener("click", () => bumpMax(-1));
    plMaxUp.addEventListener("click", () => bumpMax(+1));

    function bumpTime(delta){
      formTimeMin = clamp(formTimeMin + delta, 5, 240);
      formTimeMin = Math.round(formTimeMin / 5) * 5;
      formTimeMin = clamp(formTimeMin, 5, 240);
      renderPlayersTimeLabels();
    }
    tmDown.addEventListener("click", () => bumpTime(-5));
    tmUp.addEventListener("click", () => bumpTime(+5));

    btnTagAdd.addEventListener("click", async () => {
      try{
        const raw = fTagInput.value;
        const t = normTag(raw);
        if(!t) return;

        addTagToForm(t);
        fTagInput.value = "";
        fTagInput.focus();

        await upsertTagToDB(t);

        setAdminStatus("ã‚¿ã‚°ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆä»¥é™ã‚‚å€™è£œã«å‡ºã¾ã™ï¼‰", "ok");
        setTimeout(() => setAdminStatus("", null), 900);
      }catch(err){
        setAdminStatus(err?.message || String(err || ""), "err");
      }
    });

    fTagInput.addEventListener("keydown", async (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        try{
          const raw = fTagInput.value;
          const t = normTag(raw);
          if(!t) return;

          addTagToForm(t);
          fTagInput.value = "";

          await upsertTagToDB(t);

          setAdminStatus("ã‚¿ã‚°ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆä»¥é™ã‚‚å€™è£œã«å‡ºã¾ã™ï¼‰", "ok");
          setTimeout(() => setAdminStatus("", null), 900);
        }catch(err){
          setAdminStatus(err?.message || String(err || ""), "err");
        }
      }
    });

    selectedTagsEl.addEventListener("click", (e) => {
      const chip = e.target.closest(".tagPickChip.on");
      if(!chip) return;
      if(draggingTagEl) return;

      const enc = chip.getAttribute("data-tagval") || "";
      const tag = decodeURIComponent(enc || "");
      removeTagFromForm(tag);
    });

    selectedTagsEl.addEventListener("dragstart", (e) => {
      const chip = e.target.closest(".tagPickChip.on");
      if(!chip) return;
      draggingTagEl = chip;
      chip.classList.add("dragging");
      try{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", chip.getAttribute("data-tagval") || "");
      }catch(_){}
    });

    selectedTagsEl.addEventListener("dragover", (e) => {
      if(!draggingTagEl) return;
      e.preventDefault();

      const over = e.target.closest(".tagPickChip.on");
      if(!over || over === draggingTagEl) return;

      const rect = over.getBoundingClientRect();
      const before = (e.clientX - rect.left) < rect.width / 2;
      selectedTagsEl.insertBefore(draggingTagEl, before ? over : over.nextSibling);
    });

    selectedTagsEl.addEventListener("drop", (e) => {
      if(!draggingTagEl) return;
      e.preventDefault();

      const ordered = [...selectedTagsEl.querySelectorAll(".tagPickChip.on")]
        .map(el => decodeURIComponent(el.getAttribute("data-tagval") || ""))
        .map(normTag)
        .filter(Boolean);

      formTags = ordered;
      renderTagsUI();
      setAdminStatus("ã‚¿ã‚°ã®é †ç•ªã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚", "ok");
      setTimeout(() => setAdminStatus("", null), 700);
    });

    selectedTagsEl.addEventListener("dragend", () => {
      if(draggingTagEl){
        draggingTagEl.classList.remove("dragging");
      }
      draggingTagEl = null;
    });

    tagSuggestionsEl.addEventListener("click", async (e) => {
      const del = e.target.closest("[data-del]");
      if(del){
        const k = del.getAttribute("data-del") || "";
        e.preventDefault();
        e.stopPropagation();
        try{
          await deleteTagFromDB(k);
        }catch(err){
          setAdminStatus(err?.message || String(err || ""), "err");
        }
        return;
      }

      const chip = e.target.closest("[data-tag]");
      if(!chip) return;
      const tag = chip.getAttribute("data-tag") || "";
      toggleTag(tag);
    });

    grid.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action='editGame']");
      if(!btn) return;
      const id = btn.getAttribute("data-id") || "";
      if(!id) return;
      e.preventDefault();
      e.stopPropagation();
      startEdit(id);
    });

    // =========================
    // âœ… Special tile click: open NOW PLAY with ?room=HHMM (+ _t)
    // =========================
    grid.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action='nowPlayOpen']");
      if(!btn) return;

      e.preventDefault();
      e.stopPropagation();

      if(!nowPlay || !nowPlay.url || !nowPlay.hhmm){
        toast("NOW PLAY ãŒæœªè¨­å®šã§ã™", 1100);
        return;
      }
      const openUrl = appendRoomParam(nowPlay.url, nowPlay.hhmm);
      window.open(openUrl, "_blank", "noopener,noreferrer");
    });

    // =========================
    // âœ… secondframeï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šã¤ãã§ã€Œè¡¨ç¤ºã€ã ã‘
    // =========================
    grid.addEventListener("pointerdown", (e) => {
      const sf = e.target.closest(".secondframe[data-action='sf']");
      if(!sf) return;
      const slot = e.target.closest(".slot");
      if(!slot) return;
      if(slot.getAttribute("data-special") === "1") return;

      if(slot.getAttribute("data-hasprev") !== "1") return;

      SF_CLICK.active = true;
      SF_CLICK.moved = false;
      SF_CLICK.startX = e.clientX;
      SF_CLICK.startY = e.clientY;
      SF_CLICK.movedDist = 0;
      SF_CLICK.downTime = Date.now();
    }, { passive:true });

    grid.addEventListener("pointermove", (e) => {
      if(!SF_CLICK.active) return;
      const dx = e.clientX - SF_CLICK.startX;
      const dy = e.clientY - SF_CLICK.startY;
      const dist = Math.hypot(dx, dy);
      SF_CLICK.movedDist = dist;
      if(dist > 10){
        SF_CLICK.moved = true;
      }
    }, { passive:true });

    grid.addEventListener("pointerup", (e) => {
      if(!SF_CLICK.active) return;
      SF_CLICK.active = false;

      const dt = Date.now() - SF_CLICK.downTime;
      if(SF_CLICK.moved) return;
      if(dt > 450) return;

      const sf = e.target.closest(".secondframe[data-action='sf']");
      if(!sf) return;
      const slot = e.target.closest(".slot");
      if(!slot) return;
      if(slot.getAttribute("data-special") === "1") return;

      openSfOverlayForSlot(slot);
      suppressNextClick(450);
    }, { passive:true });

    function closeOverlay(ov){
      if(!ov) return;
      ov.classList.remove("show");
      ov.setAttribute("aria-hidden","true");
    }

    grid.addEventListener("click", (e) => {
      const isLink = !!e.target.closest(".sfImgLink");

      if(isSuppressedClick() && !isLink){
        e.preventDefault();
        e.stopPropagation();
        return;
      }

      const closeBtn = e.target.closest("[data-action='sfClose']");
      if(closeBtn){
        e.preventDefault();
        e.stopPropagation();
        const ov = closeBtn.closest(".sfOverlay");
        closeOverlay(ov);
        return;
      }

      const ov = e.target.closest(".sfOverlay.show");
      if(ov){
        if(isLink) return;
        e.preventDefault();
        e.stopPropagation();
        closeOverlay(ov);
        return;
      }
    });

    window.addEventListener("pointerdown", (e) => {
      const anyOpen = !!document.querySelector(".sfOverlay.show");
      if(!anyOpen) return;

      if(e.target.closest(".sfInner")) return;
      if(e.target.closest(".secondframe")) return;
      if(e.target.closest("[data-action='sfClose']")) return;
      if(e.target.closest(".sfImgLink")) return;

      closeAllSfOverlays();
    }, { passive:true });

    function closeOnScroll(){
      if(document.querySelector(".sfOverlay.show")){
        closeAllSfOverlays();
      }
    }
    window.addEventListener("wheel", closeOnScroll, { passive:true });
    window.addEventListener("touchmove", closeOnScroll, { passive:true });
    window.addEventListener("scroll", closeOnScroll, { passive:true });

    // =========================
    // âœ… Long-press on a GAME tile: ask password â†’ set NOW PLAY
    // =========================
    function lpCancel(){
      LP.active = false;
      LP.moved = false;
      LP.slot = null;
      clearTimeout(LP.timer);
      LP.timer = 0;
    }

    function canLongPressSlot(slot){
      if(!slot) return false;
      if(slot.getAttribute("data-special") === "1") return false;
      if(draggingSlot) return false;
      if(slot.querySelector(".sfOverlay.show")) return false;
      const gid = slot.getAttribute("data-gameid") || "";
      if(!gid) return false;
      const url = slot.getAttribute("data-url") || "";
      const prev = slot.getAttribute("data-preview") || "";
      if(!url || !prev) return false;
      return true;
    }

    grid.addEventListener("pointerdown", (e) => {
      if(e.target.closest(".sfOverlay")) return;
      if(e.target.closest("[data-action='sfClose']")) return;
      if(e.target.closest("[data-action='editGame']")) return;

      const slot = e.target.closest(".slot");
      if(!slot) return;

      if(!canLongPressSlot(slot)) return;

      LP.active = true;
      LP.moved = false;
      LP.slot = slot;
      LP.startX = e.clientX;
      LP.startY = e.clientY;

      clearTimeout(LP.timer);
      LP.timer = setTimeout(() => {
        if(!LP.active || LP.moved || !LP.slot) return;

        const gid = LP.slot.getAttribute("data-gameid") || "";
        const url = LP.slot.getAttribute("data-url") || "";
        const previewImg = LP.slot.getAttribute("data-preview") || "";
        const name = LP.slot.getAttribute("data-name") || "";

        openPwForGame({ gid, url, previewImg, name });

        suppressNextClick(650);
        lpCancel();
      }, 650);
    }, { passive:true });

    grid.addEventListener("pointermove", (e) => {
      if(!LP.active) return;
      const dx = e.clientX - LP.startX;
      const dy = e.clientY - LP.startY;
      if(Math.hypot(dx, dy) > 12){
        LP.moved = true;
        clearTimeout(LP.timer);
      }
    }, { passive:true });

    grid.addEventListener("pointerup", () => {
      if(!LP.active) return;
      lpCancel();
    }, { passive:true });

    grid.addEventListener("pointercancel", () => {
      if(!LP.active) return;
      lpCancel();
    }, { passive:true });

    // =========================
    // âœ… Password modal events
    // =========================
    btnPwClose.addEventListener("click", () => showPwModal(false));
    btnPwCancel.addEventListener("click", () => showPwModal(false));
    pwModalOverlay.addEventListener("click", (e) => { if(e.target === pwModalOverlay) showPwModal(false); });
    btnPwOk.addEventListener("click", () => { confirmPw(); });
    pwInput.addEventListener("keydown", (e) => { if(e.key === "Enter") confirmPw(); });

    // =========================
    // âœ… Drag & Dropï¼ˆè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ï¼‰
    // =========================
    grid.addEventListener("dragstart", (e) => {
      const slot = e.target.closest(".slot");
      if(!slot) return;

      const isMy = slot.getAttribute("data-my") === "1";
      const gid = slot.getAttribute("data-gameid") || "";
      if(!isMy || !gid) return;

      if(slot.querySelector(".sfOverlay.show")) return;

      draggingSlot = slot;
      slot.classList.add("dragging");
      dropHint.textContent = "ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆä¸­â€¦";
      dropHint.classList.add("show");

      try{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", gid);
      }catch(_){}
    });

    grid.addEventListener("dragover", (e) => {
      if(!draggingSlot) return;
      e.preventDefault();

      const over = e.target.closest(".slot");
      if(!over) return;

      if(over.getAttribute("data-my") !== "1") return;

      const mySlots = getMySlotsInDom();
      if(!mySlots.length) return;

      const after = getGridAfterElement(mySlots, e.clientX, e.clientY);

      if(after){
        if(after !== draggingSlot){
          grid.insertBefore(draggingSlot, after);
          requestSyncLayout();
        }
      }else{
        const lastMy = [...getMySlotsInDom()].filter(el => el !== draggingSlot).slice(-1)[0] || null;
        const anchor = lastMy ? lastMy.nextSibling : null;
        grid.insertBefore(draggingSlot, anchor);
        requestSyncLayout();
      }
    });

    grid.addEventListener("drop", (e) => {
      if(!draggingSlot) return;
      e.preventDefault();
      persistMyOrderToGames();
      requestSyncLayout();
    });

    grid.addEventListener("dragend", () => {
      if(draggingSlot){
        draggingSlot.classList.remove("dragging");
      }
      draggingSlot = null;
      setTimeout(() => {
        if(!draggingSlot) dropHint.classList.remove("show");
      }, 400);
      requestSyncLayout();
    });

    window.addEventListener("resize", () => {
      clearTimeout(window.__descResizeT);
      window.__descResizeT = setTimeout(requestSyncLayout, 120);
    });

    // =========================
    // âœ… iOS/ã‚¹ãƒãƒ›å¯¾ç­–ï¼šå¾©å¸°æ™‚ã«å¿…ãšå†èª­è¾¼ï¼†å†æç”»
    // - Safariã®BFCacheã§ã€ŒJSãŒæ­¢ã¾ã£ãŸã¾ã¾ã€ã«ãªã‚‹ã®ã‚’é˜²ã
    // =========================
    window.addEventListener("pageshow", (e) => {
      // BFCacheå¾©å¸°ã§ã‚‚ã€NOW PLAYï¼ˆlocalï¼‰ã‚’å†èª­è¾¼ã—ã¦å†æç”»
      const local = loadNowPlay();
      saveNowPlayLocal(local);
      renderGrid();
      requestSyncLayout();
    });

    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible"){
        const local = loadNowPlay();
        saveNowPlayLocal(local);
        renderGrid();
        requestSyncLayout();
      }
    });

    // =========================
    // âœ… Start
    // =========================
    window.addEventListener("load", () => {
      try{
        const cached = localStorage.getItem(LS_AUTH_EMAIL) || "";
        if(cached) authEmail.value = cached;
      }catch(_){}

      // âœ… æœ€åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚è¦‹ãˆã‚‹ï¼‰
      nowPlay = loadNowPlay();

      resetFormState();
      setEditMode(false);

      renderGrid();
      updateAuthUI();

      initFirebase();

      requestSyncLayout();
      setTimeout(requestSyncLayout, 250);
    });

    /*
      âœ… Realtime Database ãƒ«ãƒ¼ãƒ«ä¾‹ï¼ˆNOW PLAY ã‚’DBåŒæœŸã™ã‚‹ç‰ˆï¼‰

      {
        "rules": {
          "games": {
            ".read": true,
            "$gid": {
              ".write": "auth != null && ( (!data.exists() && newData.child('createdBy').val() === auth.uid) || (data.exists() && data.child('createdBy').val() === auth.uid) )"
            }
          },
          "tags": {
            ".read": true,
            "$tagKey": {
              ".write": "auth != null"
            }
          },
          "nowPlay": {
            ".read": true,
            "current": {
              ".write": "auth != null"
            }
          }
        }
      }
    */
  </script>
</body>
</html>
