<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ã‹ã‚ã®ãƒœãƒ‰ã‚²</title>

  <!-- âœ… Firebase (v9 compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    :root{
      --bg:#0b0d10;
      --line:rgba(255,255,255,.08);
      --text:#e9edf3;
      --muted:rgba(233,237,243,.72);
      --accent:#7dd3fc;
      --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.35);

      /* âœ… å¾Œã§åˆ¥ã€…ã«å¤‰ãˆã‚‰ã‚Œã‚‹ã€Œã‚µã‚¤ã‚ºå®šç¾©ã€ */
      --imgBoxSize: 1fr;
      --descBoxSize: 1fr;
      --boxGap: 10px;

      /* âœ… å³ã®èª¬æ˜æ ã‚’â€œç¸¦é•·â€ã«ã™ã‚‹ */
      --descAR: 1 / 1.28;

      /* âœ… ç”»åƒæ ã‚’å³ã¸ã©ã‚Œã ã‘é‡ã­ã‚‹ã‹ */
      --imgOverlap: 50%;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(125,211,252,.14), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(167,139,250,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,13,16,.92), rgba(11,13,16,.72));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 16px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.02em;
      font-size:18px;
      user-select:none;
    }
    .turtle{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(125,211,252,.35), rgba(167,139,250,.25));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
    }
    .turtle span{font-size:18px; transform: translateY(-1px);}

    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .topBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-weight:800;
      letter-spacing:.02em;
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .topBtn:hover{ background: rgba(255,255,255,.09); border-color: rgba(125,211,252,.35); }
    .topBtn:active{ transform: translateY(1px); }
    .topBtn.primary{
      border-color: rgba(125,211,252,.45);
      background: rgba(125,211,252,.14);
    }
    .badge{
      font-size:12px;
      color: rgba(233,237,243,.75);
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      max-width: 320px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .grid{
      max-width:1100px;
      margin:0 auto;
      padding:16px 16px 26px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      align-items:start;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    /* âœ… 2æ ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹åœŸå°ï¼ˆé‡ã­ã‚‹ã®ã§ position:relativeï¼‰ */
    .slot{
      position:relative;
      display:grid;
      grid-template-columns: var(--imgBoxSize) var(--descBoxSize);
      gap: var(--boxGap);
      align-items:start;
      background: transparent;
      border:0;
      border-radius:0;
      box-shadow:none;
      overflow: visible;
      min-height:0;
    }

    .box{
      background: linear-gradient(180deg, rgba(18,22,28,.95), rgba(15,19,24,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width:0;
      min-height:0;
      position:relative;
    }

    .descBox{
      aspect-ratio: var(--descAR);
      padding:12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:1;
    }

    .gameLink{
      color:var(--text);
      text-decoration:none;
      font-weight:900;
      font-size:15px;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      display:block;
    }
    .gameLink:hover{color: var(--accent);}

    .desc{
      margin:0;
      color: var(--muted);
      line-height:1.45;
      font-size:13px;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 12;
      -webkit-box-orient: vertical;
    }

    .imgBox{
      aspect-ratio: 1 / 1;
      z-index:3;
      transform: translateX(var(--imgOverlap));
      background: transparent !important;
      border: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      overflow: visible !important;
      padding: 0;
    }
    .imgBox .previewImg{
      position:absolute; inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      object-position: center;
      display:block;
      pointer-events:none;
      user-select:none;
    }
    .imgBox .empty{
      position:absolute; inset:0;
      display:grid; place-items:center;
      color: rgba(233,237,243,.35);
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      user-select:none;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 14px;
      backdrop-filter: blur(2px);
    }

    .footnote{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 22px;
      color: rgba(233,237,243,.55);
      font-size:12px;
      line-height:1.6;
    }
    .footnote code{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 6px;
      border-radius:8px;
    }

    @media (max-width: 520px){
      .slot{ grid-template-columns: 1fr; gap: 10px; }
      .imgBox{ transform:none; z-index:1; }
      .descBox{ z-index:1; }
    }

    /* ---------- modal ---------- */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(560px, 100%);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(18,22,28,.98), rgba(12,14,18,.98));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalTitle{font-weight:900; letter-spacing:.02em;}
    .iconBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modalBody{padding:14px;}
    .row{display:grid; gap:10px;}
    .field{
      display:grid;
      gap:6px;
    }
    label{font-size:12px; color: rgba(233,237,243,.75); font-weight:800;}
    input, textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:110px; resize:vertical;}
    input:focus, textarea:focus{ border-color: rgba(125,211,252,.45); }

    .help{
      font-size:12px;
      color: rgba(233,237,243,.65);
      line-height:1.5;
      margin: 4px 0 0;
    }
    .err{
      margin-top:10px;
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.28);
      color: rgba(255,255,255,.92);
      padding:10px 10px;
      border-radius: 14px;
      font-size:12px;
      line-height:1.45;
      display:none;
      white-space:pre-wrap;
    }
    .err.show{display:block;}
    .ok{
      margin-top:10px;
      background: rgba(34,197,94,.12);
      border: 1px solid rgba(34,197,94,.28);
      color: rgba(255,255,255,.92);
      padding:10px 10px;
      border-radius: 14px;
      font-size:12px;
      line-height:1.45;
      display:none;
      white-space:pre-wrap;
    }
    .ok.show{display:block;}

    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .mutedBtn{ opacity:.9; }
    .wideBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .previewLine{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:8px;
    }
    .miniPreview{
      width:64px; height:64px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .miniPreview img{width:100%; height:100%; object-fit:contain;}
    .tiny{font-size:11px; color: rgba(233,237,243,.65);}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="turtle" aria-hidden="true"><span>ğŸ¢</span></div>
          <div>ã‹ã‚ã®ãƒœãƒ‰ã‚²</div>
        </div>

        <div class="actions">
          <span class="badge" id="userBadge" style="display:none;"></span>
          <button class="topBtn" id="btnLogin">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="topBtn primary" id="btnAdd" style="display:none;">ï¼‹ ã‚²ãƒ¼ãƒ è¿½åŠ </button>
          <button class="topBtn" id="btnLogout" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="grid" id="grid"></section>

    <div class="footnote" id="footnote">
      â€» å·¦ã®ç”»åƒæ ã¯ã€ŒèƒŒæ™¯é€éPNGã€ã‚’ç½®ãå‰æã§ã€æ /èƒŒæ™¯/å½±ã‚’æ¶ˆã—ã¦ã„ã¾ã™ã€‚<br/>
      â€» æ–°è¦è¿½åŠ ã¯å³ä¸Š <code>ãƒ­ã‚°ã‚¤ãƒ³</code> â†’ <code>ï¼‹ã‚²ãƒ¼ãƒ è¿½åŠ </code> ã‹ã‚‰ã€‚<br/>
      â€» <code>file://</code> ç›´é–‹ãã¯ Firebase Auth ã®ä»•æ§˜ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ï¼ˆã‚ªãƒªã‚¸ãƒ³nullï¼‰ã§ã™ã€‚HTTP(S)ã§é–‹ã„ã¦ãã ã•ã„ã€‚
    </div>
  </main>

  <!-- ===== Auth Modal ===== -->
  <div class="overlay" id="authOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="modalHead">
        <div class="modalTitle" id="authTitle">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</div>
        <button class="iconBtn" id="authClose">Ã—</button>
      </div>

      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label for="authEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input id="authEmail" type="email" autocomplete="email" placeholder="example@email.com">
          </div>
          <div class="field">
            <label for="authPass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input id="authPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <div class="help">â€» ã¾ãšã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’è©¦ã—ã¦ã€åˆã‚ã¦ãªã‚‰ã€Œæ–°è¦ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
          </div>

          <div class="err" id="authErr"></div>
          <div class="ok" id="authOk"></div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="topBtn mutedBtn" id="btnSignup">æ–°è¦ç™»éŒ²</button>
        <button class="topBtn primary" id="btnDoLogin">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <!-- ===== Add Game Modal ===== -->
  <div class="overlay" id="addOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle">
      <div class="modalHead">
        <div class="modalTitle" id="addTitle">ã‚²ãƒ¼ãƒ è¿½åŠ </div>
        <button class="iconBtn" id="addClose">Ã—</button>
      </div>

      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label for="gName">é¡Œå</label>
            <input id="gName" type="text" placeholder="ä¾‹ï¼šæ–°ã—ã„ã‚²ãƒ¼ãƒ ">
          </div>
          <div class="field">
            <label for="gDesc">èª¬æ˜</label>
            <textarea id="gDesc" placeholder="çŸ­ã„ç´¹ä»‹æ–‡"></textarea>
          </div>
          <div class="field">
            <label for="gUrl">ãƒªãƒ³ã‚¯</label>
            <input id="gUrl" type="url" placeholder="https://example.com/">
            <div class="help">â€» http(s) ãŒç„¡ã„å ´åˆã¯è‡ªå‹•ã§ https:// ã‚’ä»˜ã‘ã¾ã™ã€‚</div>
          </div>

          <div class="field">
            <label for="gImgFile">ç”»åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</label>
            <input id="gImgFile" type="file" accept="image/*">
            <div class="help">â€» é¸ã‚“ã ç”»åƒã¯ Firebase Storage ã«ä¿å­˜ã—ã¾ã™ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆï¼‰ã€‚</div>

            <div class="previewLine">
              <div class="miniPreview" id="miniPreview"><span class="tiny">NO IMG</span></div>
              <div class="tiny" id="miniInfo"></div>
            </div>
          </div>

          <div class="field">
            <label for="gImgUrl">ç”»åƒï¼ˆURLã§ã‚‚å¯ãƒ»ä»»æ„ï¼‰</label>
            <input id="gImgUrl" type="url" placeholder="https://...png">
            <div class="help">â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚</div>
          </div>

          <div class="err" id="addErr"></div>
          <div class="ok" id="addOk"></div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="topBtn" id="btnCancelAdd">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="topBtn primary" id="btnSaveGame">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Firebase Config
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDUP1foVQnitM45do_UtYLkcc9gvgQC-xw",
      authDomain: "timebomb-3b0c7.firebaseapp.com",
      databaseURL: "https://timebomb-3b0c7-default-rtdb.firebaseio.com",
      projectId: "timebomb-3b0c7",
      storageBucket: "timebomb-3b0c7.firebasestorage.app",
      messagingSenderId: "532935786630",
      appId: "1:532935786630:web:ef1f97c862bfaad67d1107",
      measurementId: "G-K8NRR8K64Y"
    };

    // =========================
    // UI Elements
    // =========================
    const grid = document.getElementById("grid");

    const btnLogin  = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnAdd    = document.getElementById("btnAdd");
    const userBadge = document.getElementById("userBadge");

    const authOverlay = document.getElementById("authOverlay");
    const authClose = document.getElementById("authClose");
    const btnDoLogin = document.getElementById("btnDoLogin");
    const btnSignup = document.getElementById("btnSignup");
    const authEmail = document.getElementById("authEmail");
    const authPass  = document.getElementById("authPass");
    const authErr = document.getElementById("authErr");
    const authOk  = document.getElementById("authOk");

    const addOverlay = document.getElementById("addOverlay");
    const addClose = document.getElementById("addClose");
    const btnCancelAdd = document.getElementById("btnCancelAdd");
    const btnSaveGame = document.getElementById("btnSaveGame");
    const gName = document.getElementById("gName");
    const gDesc = document.getElementById("gDesc");
    const gUrl  = document.getElementById("gUrl");
    const gImgFile = document.getElementById("gImgFile");
    const gImgUrl  = document.getElementById("gImgUrl");
    const addErr = document.getElementById("addErr");
    const addOk  = document.getElementById("addOk");
    const miniPreview = document.getElementById("miniPreview");
    const miniInfo = document.getElementById("miniInfo");

    function showOverlay(el){ el.classList.add("show"); el.setAttribute("aria-hidden","false"); }
    function hideOverlay(el){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }
    function setErr(box, msg){ box.textContent = msg || ""; box.classList.toggle("show", !!msg); }
    function setOk(box, msg){ box.textContent = msg || ""; box.classList.toggle("show", !!msg); }

    function isFileProtocol(){
      return location.protocol === "file:";
    }

    // =========================
    // Default (kept)
    // =========================
    const defaultGames = [
      { name:"ã‚¿ã‚¤ãƒ ãƒœãƒ ",     url:"https://jessedeerridge.github.io/timebomb/",         desc:"çˆ†ç™ºã«æ°—ã‚’ä»˜ã‘ãªãŒã‚‰ã€çˆ†å¼¾ã‚’è§£é™¤ã—ã‚ˆã†ï¼", img:"" },
      { name:"ãƒœãƒ ãƒã‚¹ã‚¿ãƒ¼ã‚º", url:"https://jessedeerridge.github.io/bombjessebusters/", desc:"å”åŠ›ã—ã¦çˆ†å¼¾ã‚’è§£é™¤ã—ã‚ˆã†ï¼",               img:"" },
      { name:"ãƒ¯ãƒ¼ãƒ¯ãƒ¼ã‚º",     url:"https://jessedeerridge.github.io/werewords/",        desc:"å”åŠ›ã—ã¦å˜èªã‚’å½“ã¦ã‚ï¼",                     img:"" },
      { name:"ãƒãƒ¼ã‚ºæ³¥æ£’",     url:"https://jessedeerridge.github.io/cheesetheft/",      desc:"3æ™‚ã«èµ·ããŸæ™‚ã«ã¯ã¾ã ãƒãƒ¼ã‚ºã¯ã‚ã£ãŸã‚ˆã€‚ãƒãƒ¼ã‚ºã‚’é£Ÿã¹ãŸå˜˜ã¤ãã¯èª°ã ï¼Ÿ", img:"" },
      { name:"ãƒã‚¤ãƒã‚¸ãƒ§",     url:"https://jessedeerridge.github.io/mymajo/",           desc:"ãŠå¯¿å¸ã®å®šç•ªãƒã‚¿ã¨ã„ãˆã°ï¼Ÿ ãƒã‚¸ãƒ§ãƒªãƒ†ã‚£ãªã‚‰æ„è¦‹ã¯ä¸€è‡´ã™ã‚‹ã¯ãšï¼ ãƒã‚¤ãƒãƒªãƒ†ã‚£ã¯èª°ã ï¼Ÿ", img:"" },
      { name:"ã‚¶ãƒ»ã‚«ã‚«ãƒ",     url:"https://jessedeerridge.github.io/kakapo/",           desc:"å”åŠ›ã—ã¦é³¥ã‚’æ•ç²ï¼é ­ã‚’ä½¿ã£ã¦ãƒ”ãƒ¼ã‚¹ã‚’ä¸Šæ‰‹ãä¸¦ã¹ãªã‘ã‚Œã°ã„ã‘ãªã„ï¼", img:"" },
      { name:"ç™½è–”è–‡ã¨åˆƒ",     url:"https://jessedeerridge.github.io/shirobara/",        desc:"ç™½è–”è–‡ã‚’å®ˆã‚ã†ï¼", img:"" },
      { name:"ã‚·ãƒ£ãƒ‰ã‚¦ãƒ»ãƒ¬ã‚¤ãƒ€ãƒ¼ã‚º", url:"https://jessedeerridge.github.io/shadowraiders/", desc:"å¹³å’Œã®ãŸã‚ã«æˆ¦ã†ãï¼ã“ã®ä¸–ç•Œã¯å¾è¼©ã®ç‰©ã ... æ­£ç¾©VSæ‚ªï¼ã§ã‚‚ã€ã‚ãªãŸã¯å‘³æ–¹ï¼Ÿ", img:"" },
      { name:"ITO",            url:"https://jessedeerridge.github.io/ito/",              desc:"ç„¡äººå³¶ã«ã‚‚ã£ã¦ã„ããŸã„ç‰©ã¨ã„ãˆã°ã€‚1ï¼ˆã„ã‚‰ãªã„ç‰©ï¼‰â†â€¦â†’ï¼ˆã™ã”ãã‚‚ã£ã¦ã„ããŸã„ç‰©ï¼‰100ï¼æ„æ€ç–é€šã§ãã‚‹ã‹ãªï¼Ÿ", img:"" },
      { name:"HIDEOUT",        url:"https://jessedeerridge.github.io/hideout/",          desc:"çˆ†å¼¾ã«çªå…¥ã—ãªã„ã‚ˆã†ã«ã€ã‚¢ã‚¸ãƒˆã«æ½œå…¥ã—ã‚ˆã†ï¼", img:"" },
    ];

    // =========================
    // Rendering
    // =========================
    const BASE_SLOTS = 20;
    function slotHTML({name, desc, url, img} = {}, index){
      const hasGame = !!url;

      const imgBox = (hasGame && img)
        ? `<div class="box imgBox" aria-hidden="true">
             <img class="previewImg" src="${escapeAttr(img)}" alt="">
           </div>`
        : `<div class="box imgBox" aria-hidden="true">
             <div class="empty">PNG HERE</div>
           </div>`;

      const title = hasGame
        ? `<a class="gameLink" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(name)}</a>`
        : `<span class="gameLink" style="opacity:.45; pointer-events:none;">ï¼ˆç©ºãï¼‰</span>`;

      const description = hasGame
        ? `<p class="desc">${escapeHTML(desc || "")}</p>`
        : `<p class="desc" style="opacity:.45;">ã“ã“ã¯ç©ºæ ã§ã™</p>`;

      return `
        <article class="slot" aria-label="slot-${index+1}">
          ${imgBox}
          <div class="box descBox">
            ${title}
            ${description}
          </div>
        </article>
      `;
    }

    // basic escaping
    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      // attribute safe (minimal)
      return escapeHTML(s).replaceAll("\n","").replaceAll("\r","");
    }

    // Firebase games (from Firestore)
    let remoteGames = []; // {name, desc, url, img}
    function render(){
      const merged = [...remoteGames, ...defaultGames];
      const total = Math.max(BASE_SLOTS, merged.length);
      const slots = Array.from({length: total}, (_, i) => merged[i] ?? {});
      grid.innerHTML = slots.map(slotHTML).join("");
    }

    // =========================
    // Firebase init (guard)
    // =========================
    let app, auth, db, storage;
    let unsubGames = null;

    function initFirebase(){
      if (!window.firebase) {
        console.error("Firebase SDK not loaded yet");
        return;
      }
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      storage = firebase.storage();

      // Persistence (ãƒ­ã‚°ã‚¤ãƒ³ç¶­æŒ)
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    }

    // =========================
    // Auth UI
    // =========================
    function openAuth(){
      setErr(authErr,"");
      setOk(authOk,"");
      if (isFileProtocol()){
        // file:// ã¯å¿…ãšè½ã¡ã‚‹ã®ã§ã€å…ˆã«æ˜ç¤º
        setErr(authErr,
`ã“ã®ãƒšãƒ¼ã‚¸ã¯ file://ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç›´é–‹ãï¼‰ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€Firebase Auth ã®ä»•æ§˜ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã€‚
å¯¾å‡¦ï¼š
ãƒ»VSCode Live Server ç­‰ã§ http://localhost ã§é–‹ã
ãƒ»GitHub Pages / Firebase Hosting ã§ https ã§é–‹ã
ãƒ»/files ã®ã‚ˆã†ãªHTTPé…ä¿¡ã§é–‹ã

â€»åŸå› ï¼šã‚ªãƒªã‚¸ãƒ³ãŒ "null" ã«ãªã‚Šã€Authentication ã® Authorized domains ã«ç™»éŒ²ã§ããªã„ãŸã‚`);
      }
      showOverlay(authOverlay);
      setTimeout(()=>authEmail.focus(), 50);
    }
    function closeAuth(){ hideOverlay(authOverlay); }

    function openAdd(){
      setErr(addErr,"");
      setOk(addOk,"");
      gName.value = "";
      gDesc.value = "";
      gUrl.value  = "";
      gImgFile.value = "";
      gImgUrl.value  = "";
      miniPreview.innerHTML = '<span class="tiny">NO IMG</span>';
      miniInfo.textContent = "";
      showOverlay(addOverlay);
      setTimeout(()=>gName.focus(), 50);
    }
    function closeAdd(){ hideOverlay(addOverlay); }

    btnLogin.addEventListener("click", openAuth);
    authClose.addEventListener("click", closeAuth);
    authOverlay.addEventListener("click", (e)=>{ if(e.target === authOverlay) closeAuth(); });

    btnAdd.addEventListener("click", openAdd);
    addClose.addEventListener("click", closeAdd);
    btnCancelAdd.addEventListener("click", closeAdd);
    addOverlay.addEventListener("click", (e)=>{ if(e.target === addOverlay) closeAdd(); });

    btnLogout.addEventListener("click", async ()=>{
      try{ await auth.signOut(); }catch(e){ console.warn(e); }
    });

    // Preview for image file
    gImgFile.addEventListener("change", ()=>{
      const f = gImgFile.files && gImgFile.files[0];
      if (!f){
        miniPreview.innerHTML = '<span class="tiny">NO IMG</span>';
        miniInfo.textContent = "";
        return;
      }
      const url = URL.createObjectURL(f);
      miniPreview.innerHTML = `<img src="${url}" alt="">`;
      miniInfo.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
    });

    // =========================
    // Auth Actions
    // =========================
    async function doLogin(){
      setErr(authErr,"");
      setOk(authOk,"");
      const email = (authEmail.value || "").trim();
      const pass  = (authPass.value || "").trim();
      if (!email || !pass){
        setErr(authErr, "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        setOk(authOk, "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
        setTimeout(closeAuth, 350);
      }catch(e){
        // ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã‚’äººé–“å‘ã‘ã«
        const code = e && e.code ? e.code : "";
        if (code === "auth/unauthorized-domain"){
          setErr(authErr,
`ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼šunauthorized-domain
å¯¾å‡¦ï¼šFirebase Console â†’ Authentication â†’ Settings â†’ Authorized domains ã«
ä»Šé–‹ã„ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šlocalhost / 127.0.0.1 / GitHub Pagesãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã€‚
â€» file:// ã¯ä¸å¯ã§ã™ã€‚`);
        }else if (code === "auth/user-not-found"){
          setErr(authErr, "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°è¦ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        }else if (code === "auth/wrong-password"){
          setErr(authErr, "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚");
        }else if (code === "auth/invalid-email"){
          setErr(authErr, "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        }else{
          setErr(authErr, `ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${code || ""}\n${e.message || e}`);
        }
      }
    }

    async function doSignup(){
      setErr(authErr,"");
      setOk(authOk,"");
      const email = (authEmail.value || "").trim();
      const pass  = (authPass.value || "").trim();
      if (!email || !pass){
        setErr(authErr, "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        setOk(authOk, "ç™»éŒ²ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™ã€‚");
        setTimeout(closeAuth, 350);
      }catch(e){
        const code = e && e.code ? e.code : "";
        if (code === "auth/email-already-in-use"){
          setErr(authErr, "ãã®ãƒ¡ãƒ¼ãƒ«ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        }else if (code === "auth/weak-password"){
          setErr(authErr, "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ï¼ˆã‚‚ã†å°‘ã—é•·ãã—ã¦ãã ã•ã„ï¼‰ã€‚");
        }else if (code === "auth/unauthorized-domain"){
          setErr(authErr,
`unauthorized-domain ã§ã™ã€‚
å¯¾å‡¦ï¼šFirebase Console â†’ Authentication â†’ Settings â†’ Authorized domains ã«ä»Šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
â€» file:// ã¯ä¸å¯ã§ã™ã€‚`);
        }else{
          setErr(authErr, `ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${code || ""}\n${e.message || e}`);
        }
      }
    }

    btnDoLogin.addEventListener("click", doLogin);
    btnSignup.addEventListener("click", doSignup);
    authPass.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") doLogin();
    });

    // =========================
    // Firestore realtime load
    // =========================
    function startGamesListener(){
      if (unsubGames) { unsubGames(); unsubGames = null; }
      // createdAt desc. createdAtãŒnullã§ã‚‚ä¸¦ã¶ã‚ˆã†ã«fallbackå‡¦ç†ã¯renderå´
      unsubGames = db.collection("games")
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot((snap)=>{
          const list = [];
          snap.forEach(doc=>{
            const d = doc.data() || {};
            list.push({
              id: doc.id,
              name: d.name || "",
              desc: d.desc || "",
              url:  d.url || "",
              img:  d.img || ""
            });
          });
          remoteGames = list;
          render();
        }, (err)=>{
          console.warn(err);
          // æ¨©é™ãŒé–‰ã˜ã¦ã„ã‚‹ã¨ã“ã“ã«æ¥ã‚‹
          remoteGames = [];
          render();
          const msg = (err && err.message) ? err.message : String(err);
          document.getElementById("footnote").innerHTML =
            `Firestore ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ï¼š<code>${escapeHTML(msg)}</code><br/>
             ã‚‚ã— <code>Missing or insufficient permissions</code> ãªã‚‰ã€Firestore ãƒ«ãƒ¼ãƒ«ã§ games ã® read ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚`;
        });
    }

    // =========================
    // Add Game Save
    // =========================
    function normalizeUrl(u){
      u = (u || "").trim();
      if (!u) return "";
      // æ—¢ã« http(s) ãªã‚‰ãã®ã¾ã¾
      if (/^https?:\/\//i.test(u)) return u;
      // //example.com ã¿ãŸã„ãªã®ã‚‚è£œæ­£
      if (/^\/\//.test(u)) return "https:" + u;
      return "https://" + u;
    }

    async function uploadImageFile(file, docId){
      const safeName = (file.name || "image").replace(/[^\w.\-]+/g, "_");
      const path = `game_images/${docId}/${Date.now()}_${safeName}`;
      const ref = storage.ref().child(path);
      const snap = await ref.put(file);
      const url = await snap.ref.getDownloadURL();
      return url;
    }

    async function saveGame(){
      setErr(addErr,"");
      setOk(addOk,"");

      const user = auth.currentUser;
      if (!user){
        setErr(addErr, "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const name = (gName.value || "").trim();
      const desc = (gDesc.value || "").trim();
      const url  = normalizeUrl(gUrl.value);

      if (!name){
        setErr(addErr, "é¡Œåã¯å¿…é ˆã§ã™ã€‚");
        return;
      }
      if (!url){
        setErr(addErr, "ãƒªãƒ³ã‚¯ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }

      const file = gImgFile.files && gImgFile.files[0];
      const imgUrlManual = normalizeUrl(gImgUrl.value); // URLã§ã‚‚OKï¼ˆä»»æ„ï¼‰

      btnSaveGame.disabled = true;
      btnSaveGame.textContent = "ä¿å­˜ä¸­â€¦";
      try{
        // ã¾ãšFirestoreã«ä½œã£ã¦docIdã‚’ç¢ºä¿
        const docRef = await db.collection("games").add({
          name,
          desc,
          url,
          img: "",            // å¾Œã§åŸ‹ã‚ã‚‹
          uid: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        let img = "";
        if (file){
          img = await uploadImageFile(file, docRef.id);
        }else if (imgUrlManual){
          img = imgUrlManual;
        }

        if (img){
          await docRef.update({ img });
        }

        setOk(addOk, "ä¿å­˜ã—ã¾ã—ãŸã€‚");
        // å°‘ã—è¦‹ã›ã¦ã‹ã‚‰é–‰ã˜ã‚‹
        setTimeout(()=>{
          closeAdd();
        }, 350);

      }catch(e){
        const code = e && e.code ? e.code : "";
        const msg  = e && e.message ? e.message : String(e);

        if (String(msg).includes("Missing or insufficient permissions")){
          setErr(addErr,
`ä¿å­˜ã«å¤±æ•—ï¼šMissing or insufficient permissions
å¯¾å‡¦ï¼šFirestore/Storage ã®ãƒ«ãƒ¼ãƒ«ã§ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® create/writeã€ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚
ï¼ˆã“ã®è¿”ç­”ã®ä¸Šã«è²¼ã£ãŸãƒ«ãƒ¼ãƒ«ä¾‹ã‚’ãã®ã¾ã¾ä½¿ã†ã®ãŒæ—©ã„ã§ã™ï¼‰`);
        }else{
          setErr(addErr, `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${code}\n${msg}`);
        }
      }finally{
        btnSaveGame.disabled = false;
        btnSaveGame.textContent = "ä¿å­˜";
      }
    }

    btnSaveGame.addEventListener("click", saveGame);

    // =========================
    // Boot
    // =========================
    function setAuthUI(user){
      if (user){
        btnLogin.style.display = "none";
        btnLogout.style.display = "";
        btnAdd.style.display = "";
        userBadge.style.display = "";
        userBadge.textContent = user.email || user.uid;
      }else{
        btnLogin.style.display = "";
        btnLogout.style.display = "none";
        btnAdd.style.display = "none";
        userBadge.style.display = "none";
        userBadge.textContent = "";
      }
    }

    function boot(){
      render(); // ã¾ãšã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¡¨ç¤º
      initFirebase();

      auth.onAuthStateChanged((user)=>{
        setAuthUI(user);
        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«é–¢ä¿‚ãªãä¸€è¦§ã¯èª­ã‚ã‚‹ï¼ˆreadè¨±å¯ã—ã¦ã‚‹å‰æï¼‰
        // ãŸã ã—ãƒ«ãƒ¼ãƒ«ãŒé–‰ã˜ã¦ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºã¯æ®‹ã‚‹
      });

      startGamesListener();
    }

    window.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
